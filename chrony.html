<HTML>
<HEAD>
<!-- Created by texi2html 1.56k from chrony.texi on 19 November 2000 -->

<TITLE>User guide for the chrony suite</TITLE>
</HEAD>
<BODY>
<H1>The chrony suite</H1>
<H2>This manual describes how to use</H2>
<H2>the programs chronyd and chronyc</H2>
<ADDRESS>Richard P. Curnow</ADDRESS>
<P>
<P><HR><P>


<H1><A NAME="SEC1" HREF="chrony_toc.html#TOC1">Introduction</A></H1>



<H2><A NAME="SEC2" HREF="chrony_toc.html#TOC2">Overview</A></H2>
<P>
Chrony is a software package for maintaining the accuracy of computer
system clocks.  It consists of a pair of programs :



<UL>
<LI><CODE>chronyd</CODE>.  This is a daemon which runs in background on the

system.  It obtains measurements (e.g. via the network) of the system's
offset relative to other systems, and adjusts the system time
accordingly.  For isolated systems, the user can periodically enter the
correct time by hand (using <CODE>chronyc</CODE>).  In either case,
<CODE>chronyd</CODE> determines the rate at which the computer gains or loses
time, and compensates for this.
<LI><CODE>chronyc</CODE>.  This is a command-line driven control and

monitoring program.  An administrator can use this to fine-tune various
parameters within the daemon, add or delete servers etc whilst the
daemon is running.
</UL>



<H2><A NAME="SEC3" HREF="chrony_toc.html#TOC3">Acknowledgements</A></H2>

<P>
The <CODE>chrony</CODE> suite makes use of the algorithm known as <EM>RSA
Data Security, Inc. MD5 Message-Digest Algorithm</EM> for authenticating
messages between different machines on the network.


<P>
In writing the <CODE>chronyd</CODE> program, extensive use has been made of
RFC1305, written by David Mills.  I have occasionally referred to the
<CODE>xntp</CODE> suite's source code to check details of the protocol that
the RFC did not make absolutely clear.  The core algorithms in
<CODE>chronyd</CODE> are all completely distinct from <CODE>xntp</CODE>, however.




<H2><A NAME="SEC4" HREF="chrony_toc.html#TOC4">Availability</A></H2>



<H3><A NAME="SEC5" HREF="chrony_toc.html#TOC5">Getting the software</A></H3>
<P>
Links on <A HREF="http://www.rrbcurnow.freeuk.com/chrony/index.html">the
chrony home page</A> describe how to obtain the software.




<H3><A NAME="SEC6" HREF="chrony_toc.html#TOC6">Platforms</A></H3>
<P>
Although most of the program is portable between
Unix-like systems, there are parts that have to be tailored to each
specific vendor's system.  These are the parts that interface with the
operating system's facilities for adjusting the system clock;
different operating systems may provide different function calls to
achieve this, and even where the same function is used it may have
different quirks in its behaviour.


<P>
So far, the software is able to run in the following environments:

<UL>
<LI>Linux/i386.  The software can be compiled on Linux v2.0.x

kernels.  Linux v2.1.x kernels should also present no problem, but the
<CODE>sys_linux.c</CODE> file needs modifying to define the patchlevel (value
of 'x') at which the change to the kernel time-keeping equivalent to
that applied in v2.0.32 was included.  Until I find out which version
this was, v2.1 kernels are limited to patchlevels prior to 51.

<LI>Solaris 2.5/2.5.1 on Sparc 20 and Ultrasparc.

<LI>SunOS 4.1.4 on Sparc 2 and Sparc20.

</UL>

<P>
Closely related systems may work too, but they have not been tested.


<P>
Porting the software to other system (particularly to those supporting
an <CODE>adjtime</CODE> system call) should not be difficult, however it
requires access to such systems to test out the driver.




<H2><A NAME="SEC7" HREF="chrony_toc.html#TOC7">Relationship to other software packages</A></H2>



<H3><A NAME="SEC8" HREF="chrony_toc.html#TOC8">xntpd</A></H3>
<P>
The `reference' implementation of the Network Time Protocol is the
program <CODE>xntpd</CODE>, available via
<A HREF="http://www.eecis.udel.edu/~ntp">The NTP home page</A>.


<P>
<CODE>xntpd</CODE> is designed to support all the operating modes defined by
RFC1305, and has driver support for a large number of reference clocks
(such as GPS receivers) that can be connected directly to a computer,
thereby providing a so-called 'stratum 1' server.


<P>
Things <CODE>chronyd</CODE> can do that <CODE>xntpd</CODE> can't:



<UL>
<LI>

<CODE>chronyd</CODE> can perform usefully in an environment where access to
the time reference is intermittent.  <CODE>chronyd</CODE> estimates
<EM>both</EM> the current time offset <EM>and</EM> the rate at which the
computer's clock gains or loses time, and can use that rate estimate to
trim the clock after the reference disappears.  <CODE>xntpd</CODE> corrects
any time offset by speeding up and slowing down the computer clock, and
so could be left with a significant rate error if the reference
disappears whilst it is trying to correct a big offset.

<LI>

<CODE>chronyd</CODE> provides support for isolated networks whether the only
method of time correction is manual entry (e.g. by the administrator
looking at a clock).  <CODE>chronyd</CODE> can look at the errors corrected at
different updates to work out the rate at which the computer gains or
loses time, and use this estimate to trim the computer clock
subsequently.

<LI>

<CODE>chronyd</CODE> provides support to work out the gain or loss rate of the
`real-time clock', i.e. the clock that maintains the time when the
computer is turned off.  It can use this data when the system boots to
set the system time from a corrected version of the real-time clock.
These real-time clock facilities are only available on certain releases
of Linux, so far.

<LI>

The <CODE>xntpd</CODE> program is supported by other programs to carry out
certain functions.  <CODE>ntpdate</CODE> is used to provide an initial
correction to the system clock based on a `one-shot' sampling of other
NTP servers.  <CODE>tickadj</CODE> is used to adjust certain operating system
parameters to make <CODE>xntpd</CODE> work better.  All this functionality is
integrated into <CODE>chronyd</CODE>.
</UL>

<P>
Things <CODE>xntpd</CODE> can do that <CODE>chronyd</CODE> can't:



<UL>
<LI>

<CODE>xntpd</CODE> supports a range of different hardware reference clocks
(GPS, atomic etc) that can be connected to a computer to provide a
`stratum-1' server.  <CODE>chronyd</CODE> does not support any such hardware
<EM>yet</EM>; I don't have access to any to do any development work.
However, the software architecture should allow such equipment to be
interfaced at a later date.

<LI>

<CODE>xntpd</CODE> supports effectively all of RFC1305, including broadcast /
multicast clients, leap seconds, and extra encryption schemes for
authenticating data packets.

<LI>

<CODE>xntpd</CODE> has been ported to more types of computer / operating
system (so far).

<LI>

xntpd is designed to work solely with integer arithmetic (i.e. does not
require floating point support from its host).
</UL>



<H3><A NAME="SEC9" HREF="chrony_toc.html#TOC9">timed</A></H3>
<P>
<CODE>timed</CODE> is a program that is part of the BSD networking suite.  It
uses broadcast packets to find all machines running the daemon within a
subnet.  The machines elect a master which periodically measures the
system clock offsets of the other computers using ICMP timestamps.
Corrections are sent to each member as a result of this process.


<P>
Problems that may arise with <CODE>timed</CODE> are :



<UL>
<LI>

Because it uses broadcasts, it is not possible to isolate its
functionality to a particular group of computers; there is a risk of
upsetting other computers on the same network (e.g. where a whole
company is on the same subnet but different departments are independent
from the point of view of administering their computers.)
<LI>

The update period appears to be 10 minutes.  Computers can build up
significant offsets relative to each other in that time.  If a
computer can estimate its rate of drift it can keep itself closer to
the other computers between updates by adjusting its clock every few
seconds.  <CODE>timed</CODE> does not seem to do this.
<LI>

<CODE>timed</CODE> does not have any integrated capability for feeding
real-time into its estimates, or for estimating the average rate of time
loss/gain of the machines relative to real-time (unless one of the
computers in the group has access to an external reference and is always
appointed as the `master').
</UL>

<P>
<CODE>timed</CODE> does have the benefit over <CODE>chronyd</CODE> that for isolated
networks of computers, they will track the `majority vote' time.  For
such isolated networks, <CODE>chronyd</CODE> requires one computer to be the
`master' with the others slaved to it.  If the master has a particular
defective clock, the whole set of computers will tend to slip relative
to real time (but they <EM>will</EM> stay accurate relative to one
another).




<H2><A NAME="SEC10" HREF="chrony_toc.html#TOC10">Distribution rights and (lack of) warranty</A></H2>

<P>
{@tensf


<P>
This is the licence for the programs "chronyd" and "chronyc".  Their
source code files which reference this licence, object files /
programs (binary form) built from such source code, and the supporting
documentation are collectively referred to in this licence as "the
Software".


<P>
Certain source code files required for the construction of the Software
may be included under different licensing arrangements; you should refer
to such source code files directly for further information.  Any such
files are outside the scope of this licence.


<P>
Person(s) and/or organisation(s) holding the copyright to any part of
the source code to which this licence applies are referred to in this
licence as "the Copyright Holder(s)".


<P>
Copying and use of this licence itself, with or without modification,
are permitted for any purpose subject only to condition 6 below.


<P>
Copying, use and redistribution of the Software in source and/or binary
forms, with or without modification, and use of any part of the Software
in the creation of another work, are permitted without fee subject to
the following conditions 1 through 8 and the disclaimer below :



<OL>
<LI>

Redistributions of the Software as source code, in whole or in
part, with or without modification, must retain all existing
copyright notices and references to this licence, and must be
accompanied by a copy of this licence.  You may rename the file
containing this licence and change all references to it accordingly
if you need to. Such redistributions must be under terms that require
this list of conditions and the disclaimer below to be carried on any
subsequent redistribution.

<LI>

Redistributions in binary form (of the original version of the
Software, a modified version of the Software, or any other work which
incorporates any part of the Software), must carry in accompanying
documentation and/or other materials a notice to the effect of either
(A) or (B) below.


<OL>
<LI>

This original version of this software was written by
&#60;name(s) of Copyright Holder(s)&#62; and is used subject to the
disclaimer in the file &#60;name of file containing the
disclaimer&#62;.

<LI>

The parts of this software which &#60;describe their role in
your software&#62; were originally written by &#60;name(s) of
Copyright Holder(s)&#62; and are used subject to the disclaimer in
the file &#60;name of file containing the disclaimer&#62;.

</OL>

(You must replace each &#60;...&#62; with the appropriate information.)
   
A copy of the disclaimer below must also be included.  Such
redistributions must be under terms that require the relevant notice
(A) or (B) and the disclaimer below to be carried on any subsequent
redistribution.

As an exception, if all recipients of your distribution receive
additional rights under condition 5, and those rights supersede the
disclaimer in its entirety, then you need not include the disclaimer,
any reference to it, or the requirement for further redistributions
to carry it.

<LI>

Unless modifications to the original Software are retained for the
exclusive personal use of the modifier, each source code file that
has been modified must identify the original source version and carry
a notice describing the nature and purpose of all modifications and
the person responsible for them.  Where modified source code is
widely redistributed (e.g. outside the modifier's own organisation),
it should preferably be supplied as the original version plus
`patches' which can be applied to the original version to obtain the
modified version.

<LI>

If a modified version of the Software is distributed in any form,
it must not be misrepresented (whether by the method of distribution
or by any related advertisement or documentation) as being the
original version.  Both the documentation accompanying the software
and any advertisement related to the distribution must expressly
state that the distributed software is not the original work, and
must identify both the original work (by name and version) and the
nature and purpose of all modifications made.
   
<LI>

You may offer to any party (and charge a fee for) additional
warranty, liability rights and/or support for the Software (or a work
derived from it).  Any such offer made must be entirely on your own
behalf, and you must indemnify the Copyright Holder(s) and all other
parties through whose redistributions you have received the Software
for any liability arising out of such an offer.

<LI>

This list of conditions and the disclaimer below, when applied
either to the Software as a whole or to any part of the Software, may
only be modified by or with the express permission of the Copyright
Holder(s).

<LI>

The Copyright Holder(s) retain all rights to the Software,
including without limitation the rights to use the Software for any
purpose, to create modified and/or enhanced versions of the Software,
and to distibute such versions under terms different to those in this
licence.

<LI>

Except as required by this licence, the name(s) of the Copyright
Holder(s) may not be used to endorse or promote products derived from
the Software without their express permission obtained in advance.

</OL>

<P>
   
== Start of disclaimer ==


<P>
BECAUSE THE SOFTWARE IS PROVIDED FREE OF CHARGE, THERE IS NO WARRANTY
FOR IT, TO THE MAXIMUM EXTENT THAT APPLICABLE LAW ALLOWS.  UNLESS
OTHERWISE STATED IN WRITING OR REQUIRED BY APPLICABLE LAW, THE
COPYRIGHT HOLDER(S) AND/OR OTHER PARTIES PROVIDE THE SOFTWARE `AS IS'
AND DISCLAIM ALL WARRANTIES, EITHER EXPRESSED OR IMPLIED, INCLUDING
WITHOUT LIMITATION WARRANTIES THAT THE SOFTWARE IS FREE OF DEFECTS,
MERCHANTABLE OR FIT FOR A PARTICULAR PURPOSE.  THE USER BEARS THE
ENTIRE RISK AS TO THE QUALITY, ACCURACY AND PERFORMANCE OF THE
SOFTWARE AND THE COST OF ANY NECESSARY SERVICING, REPAIR OR CORRECTION
IN THE EVENT THAT THE SOFTWARE SHOULD PROVE DEFECTIVE.


<P>
IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
REDISTRIBUTE THE SOFTWARE, BE LIABLE TO YOU OR TO ANY OTHER PARTY FOR
DAMAGES OF ANY CHARACTER, INCLUDING WITHOUT LIMITATION ANY GENERAL,
SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES WHICH ARISE FROM THE USE
OF OR INABILITY TO USE THE SOFTWARE (INCLUDING WITHOUT LIMITATION LOSS
OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU
OR THIRD PARTIES OR A FAILURE OF THE SOFTWARE TO OPERATE WITH ANY
OTHER SOFTWARE), EVEN IF SUCH COPYRIGHT HOLDER OR OTHER PARTY HAS BEEN
ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.


<P>
== End of disclaimer ==


<P>
}




<H1><A NAME="SEC11" HREF="chrony_toc.html#TOC11">Installation</A></H1>

<P>
The software is distributed as source code which has to be compiled.
The source code is supplied in the form of a gzipped tar file, which
unpacks to a subdirectory identifying the name and version of the
program.


<P>
After unpacking the source code, change directory into it, and type



<PRE>
./configure
</PRE>

<P>
This is a shell script that automatically determines the system type.
There is a single optional parameter, <CODE>--prefix</CODE> which indicates
the directory tree where the software should be installed.  For example,



<PRE>
./configure --prefix=/opt/free
</PRE>

<P>
will install the <CODE>chronyd</CODE> daemon into /opt/free/sbin and the
chronyc control program into /opt/free/bin.  The default value for the
prefix is /usr/local.


<P>
If the software cannot (yet) be built on your system, an error message
will be shown.  Otherwise, the files <TT>`options.h'</TT> and
<TT>`Makefile'</TT> will be generated.


<P>
Now type



<PRE>
make
</PRE>

<P>
to build the programs.


<P>
Once the programs have been successfully compiled, they need to be
installed in their target locations.  This step normally needs to be
performed by the superuser, and requires the following command to be
entered.



<PRE>
make install
</PRE>

<P>
Now that the software is successfully installed, the next step is to set
up a configuration file.  The contents of this depend on the network
environment in which the computer operates.  The Debian package installs
a simple configuration file suitable for a dial-up pc.  You should edit
it to suit your situation.  Typical scenarios are described in the
following section of the document.




<H1><A NAME="SEC12" HREF="chrony_toc.html#TOC12">Typical operating scenarios</A></H1>



<H2><A NAME="SEC13" HREF="chrony_toc.html#TOC13">Computers connected to the internet</A></H2>
<P>
In this section we discuss how to configure chrony for computers that
have permanent connections to the internet (or to any network
containing true NTP servers which ultimately derive their time from a
reference clock).


<P>
To operate in this mode, you will need to know the names of the NTP
server machines you wish to use.  You may be able to find names of
suitable servers by one of the following methods:



<UL>
<LI>Your institution may already operate servers on its network.

Contact your system administrator to find out.

<LI>Your ISP probably has one or more NTP servers available for its

customers.

<LI>Somewhere under the NTP homepage there is a list of public

stratum 1 and stratum 2 servers.  You should find one or more servers
that are near to you -- check that their access policy allows you to
use their facilities.
</UL>

<P>
Assuming that you have found some servers, you need to set up a
configuration file to run chrony.  The (compiled-in) default location
for this file is <TT>`/etc/chrony.conf'</TT>.  In the Debian package the
configuration files are in the directory <TT>`/etc/chrony'</TT>.  Assuming
that your ntp servers are called <CODE>a.b.c</CODE> and <CODE>d.e.f</CODE>, your
<TT>`chrony.conf'</TT> file could contain as a minimum



<PRE>
server a.b.c
server d.e.f
server g.h.i
</PRE>

<P>
However, you will probably want to include some of the other directives
described later.  The following directives will be particularly useful :
<CODE>driftfile</CODE>, <CODE>commandkey</CODE>, <CODE>keyfile</CODE>.  The smallest
useful configuration file would look something like



<PRE>
server a.b.c
server d.e.f
server g.h.i
keyfile /etc/chrony.keys
commandkey 1
driftfile /etc/chrony.drift
</PRE>



<H2><A NAME="SEC14" HREF="chrony_toc.html#TOC14">Infrequent connection to true NTP servers</A></H2>
<P>
In this section we discuss how to configure chrony for computers that
have occasional connections to the internet.




<H3><A NAME="SEC15" HREF="chrony_toc.html#TOC15">Setting up the configuration file for infrequent connections</A></H3>
<P>
As in the previous section, you will need access to NTP servers on the
internet.  The same remarks apply for how to find them.


<P>
In this case, you will need some additional configuration to tell
<CODE>chronyd</CODE> when the connection to the internet goes up and down.
This saves the program from continuously trying to poll the servers when
they are inaccessible.


<P>
Again, assuming that your ntp servers are called <CODE>a.b.c</CODE> and
<CODE>d.e.f</CODE>, your <TT>`chrony.conf'</TT> file would need to contain
something like



<PRE>
server a.b.c
server d.e.f
server g.h.i
</PRE>

<P>
However, the following issues need to be addressed:



<OL>
<LI>

Your computer probably doesn't have DNS access whilst offline to turn
the machine names into IP addresses.
<LI>

Your computer will keep trying to contact the servers to obtain
timestamps, even whilst offline.  If you operate a dial-on-demand
system, things are even worse, because the link to the internet will
keep getting established.
</OL>

<P>
For this reason, it would be better to specify this part of your
configuration file in the following way:



<PRE>
server 1.2.3.4 offline
server 5.6.7.8 offline
server 9.10.11.12 offline
</PRE>

<P>
Because numeric IP addresses have been used, the first problem is
overcome.  The <CODE>offline</CODE> keyword indicates that the servers start
in an offline state, and that they should not be contacted until <CODE>chronyd</CODE>
receives notification that the link to the internet is present.


<P>
In order to notify <CODE>chronyd</CODE> of the presence of the link, you will
need to be able to log in to it with the program chronyc.  To do this,
<CODE>chronyd</CODE> needs to be configured with an administrator password.
The Debian package puts a default key in <TT>`/etc/chrony/chrony.keys'</TT>.
You should change it.  To set up an administrator password, you can
create a file <TT>`/etc/chrony.keys'</TT> containing a single line



<PRE>
1 xyzzy
</PRE>

<P>
and add the following line to <TT>`/etc/chrony.conf'</TT> (the order of the
lines does not matter)



<PRE>
commandkey 1
</PRE>

<P>
The smallest useful configuration file would look something like



<PRE>
server 1.2.3.4 offline
server 5.6.7.8 offline
server 9.10.11.12 offline
keyfile /etc/chrony.keys
commandkey 1
driftfile /etc/chrony.drift
</PRE>

<P>
The next section describes how to tell <CODE>chronyd</CODE> when the internet link
goes up and down.




<H3><A NAME="SEC16" HREF="chrony_toc.html#TOC16">How to tell chronyd when the internet link is available.</A></H3>
<P>
To use this option, you will need to configure a command key in
<CODE>chronyd's</CODE> configuration file <TT>`/etc/chrony.conf'</TT>, as described in
the previous section.


<P>
To tell <CODE>chronyd</CODE> when to start and finish sampling the servers, the
<CODE>online</CODE> and <CODE>offline</CODE> commands of chronyc need to be used.
To give an example of their use, we assume that <CODE>pppd</CODE> is the
program being used to connect to the internet, and that chronyc has been
installed at its default location <TT>`/usr/local/bin/chronyc'</TT>.  We
also assume that the command key has been set up as described in the
previous section.


<P>
In the file <TT>`/etc/ppp/ip-up'</TT> we add the command sequence



<PRE>
cat &#60;&#60;EOF | /usr/local/bin/chronyc
password xyzzy
online
EOF
</PRE>

<P>
and in the file <TT>`/etc/ppp/ip-down'</TT> we add the sequence



<PRE>
cat &#60;&#60;EOF | /usr/local/bin/chronyc
password xyzzy
offline
EOF
</PRE>

<P>
The Debian package puts scripts similar to those above in the
directories <TT>`/etc/ppp/ip-up.d'</TT> and <TT>`/etc/ppp/ip-down.d'</TT>.


<P>
<CODE>chronyd's</CODE> polling of the servers will now only occur whilst the
machine is actually connected to the Internet.




<H2><A NAME="SEC17" HREF="chrony_toc.html#TOC17">Isolated networks</A></H2>
<P>
In this section we discuss how to configure chrony for computers that
never have network conectivity to any computer which ultimately derives
its time from a reference clock.


<P>
In this situation, one computer is selected to be the master timeserver.
The other computers are either direct clients of the master, or clients
of clients.


<P>
The rate value in the master's drift file needs to be set to the average
rate at which the master gains or loses time.  <CODE>chronyd</CODE> includes
support for this, in the form of the <CODE>manual</CODE> directive in the
configuration file and the <CODE>settime</CODE> command in the <CODE>chronyc</CODE>
program.


<P>
If the master is rebooted, <CODE>chronyd</CODE> can re-read the drift rate
from the drift file.  However, the master has no accurate estimate of
the current time.  To get around this, the system can be configured so
that the master can initially set itself to a `majority-vote' of
selected clients' times; this allows the clients to `flywheel' the
master across its outage.


<P>
A typical configuration file for the master (called <CODE>master</CODE>) might
be (assuming the clients are in the 192.168.165.x subnet and that the
master's address is 192.168.169.170)



<PRE>
driftfile /etc/chrony.drift
commandkey 25
keyfile /etc/chrony.keys
initstepslew 10 client1 client3 client6
local stratum 8
manual
allow 192.168.165
</PRE>

<P>
For the clients that have to resynchronise the master when it restarts,
the configuration file might be



<PRE>
server master
driftfile /etc/chrony.drift
logdir /var/log/chrony
log measurements statistics tracking
keyfile /etc/chrony.keys
commandkey 24
local stratum 10
initstepslew 20 master
allow 192.168.169.170
</PRE>

<P>
The rest of the clients would be the same, except that the <CODE>local</CODE>
and <CODE>allow</CODE> directives are not required.




<H2><A NAME="SEC18" HREF="chrony_toc.html#TOC18">The home PC with a dial-up connection</A></H2>



<H3><A NAME="SEC19" HREF="chrony_toc.html#TOC19">Assumptions/how the software works</A></H3>
<P>
This section considers the home computer which has a dial-up connection.
It assumes that Linux is run exclusively on the computer.  Dual-boot
systems may work; it depends what (if anything) the other system does to
the system's real-time clock.


<P>
Much of the configuration for this case is discussed earlier
(see section <A HREF="chrony.html#SEC14">Infrequent connection to true NTP servers</A>).  This section addresses specifically
the case of a computer which is turned off between 'sessions'.


<P>
In this case, <CODE>chronyd</CODE> relies on the computer's real-time clock
(RTC) to maintain the time between the periods when it is powered up.
The arrangement is shown in the figure below.



<PRE>
            trim if required                          PSTN
      +---------------------------+               +----------+
      |                           |               |          |
      v                           |               |          |
+---------+                    +-------+       +-----+     +---+
| System's|  measure error/    |chronyd|       |modem|     |ISP|
|real-time|-------------------&#62;|       |-------|     |     |   |
|  clock  |   drift rate       +-------+       +-----+     +---+
+---------+                       ^                          |
      |                           |                          |
      +---------------------------+                  --o-----o---
         set time at boot up                           |
                                                  +----------+
                                                  |NTP server|
                                                  +----------+
</PRE>

<P>
When the computer is connected to the Internet (via the modem),
<CODE>chronyd</CODE> has access to external NTP servers which it makes
measurements from.  These measurements are saved, and straight-line fits
are performed on them to provide an estimate of the computer's time
error and rate of gaining/losing time.


<P>
When the computer is taken offline from the Internet, the best estimate
of the gain/loss rate is used to free-run the computer until it next
goes online.


<P>
Whilst the computer is running, <CODE>chronyd</CODE> makes measurements of the
real-time clock (RTC) (via the <TT>`/dev/rtc'</TT> interface, which must be
compiled into the kernel).  An estimate is made of the RTC error at a
particular RTC second, and the rate at which the RTC gains or loses time
relative to true time.


<P>
For kernels in the 2.0 series prior to 2.0.32, the kernel was set up to
trim the RTC every 11 minutes.  This would be disasterous for
<CODE>chronyd</CODE> -- there is no reliable way of synchronising with this
trimming. For this reason, <CODE>chronyd</CODE> only supports the RTC in 2.0
kernels from v2.0.32 onwards.  (I don't know anything about the kernel's
RTC behaviour in other kernel series).


<P>
When the computer is powered down, the measurement histories for all the
NTP servers are saved to files (if the <CODE>dumponexit</CODE> directive is
specified in the configuration file), and the RTC tracking information
is also saved to a file (if the <CODE>rtcfile</CODE> directive has been
specified).  These pieces of information are also saved if the
<CODE>dump</CODE> and <CODE>writertc</CODE> commands respectively are issued through
<CODE>chronyc</CODE>.


<P>
When the computer is rebooted, <CODE>chronyd</CODE> reads the current RTC time
and the RTC information saved at the last shutdown.  This information is
used to set the system clock to the best estimate of what its time would
have been now, had it been left running continuously.  The measurement
histories for the servers are then reloaded.


<P>
The next time the computer goes online, the previous sessions'
measurements can contribute to the line-fitting process, which gives a
much better estimate of the computer's gain/loss rate.


<P>
One problem with saving the measurements and RTC data when the machine
is shut down is what happens if there is a power failure; the most
recent data will not be saved.  Although <CODE>chronyd</CODE> is robust enough
to cope with this, some performance may be lost.  (The main danger
arises if the RTC has been changed during the session, with the
<CODE>trimrtc</CODE> command in <CODE>chronyc</CODE>.  Because of this,
<CODE>trimrtc</CODE> will make sure that a meaningful RTC file is saved out
after the change is completed).


<P>
The easiest protection against power failure is to put the <CODE>dump</CODE>
and <CODE>writertc</CODE> commands in the same place as the <CODE>offline</CODE>
command is issued to take <CODE>chronyd</CODE> offline; because <CODE>chronyd</CODE>
free-runs between online sessions, no parameters will change
significantly between going offline from the Internet and any power
failure.


<P>
A final point regards home computers which are left running for extended
periods and where it is desired to spin down the hard disc when it is
not in use (e.g. when not accessed for 15 minutes).  <CODE>chronyd</CODE> has
been planned so it supports such operation; this is the reason why the
RTC tracking parameters are not saved to disc after every update, but
only when the user requests such a write, or during the shutdown
sequence.  The only other facility that will generate periodic writes to
the disc is the <CODE>log rtc</CODE> facility in the configuration file; this
option should not be used if you want your disc to spin down.




<H3><A NAME="SEC20" HREF="chrony_toc.html#TOC20">Typical configuration files.</A></H3>

<P>
To illustrate how a dial-up home computer might be configured, example
configuration files are shown in this section.


<P>
For the <TT>`/etc/chrony.conf'</TT> file, the following can be used as an
example.  <EM>NOTE : The <CODE>server</CODE> directives are only applicable
to customers of Demon Internet; users of other ISPs will need to use
their own ISP's NTP servers or public NTP servers.</EM>



<PRE>
server 158.152.1.65 minpoll 5 maxpoll 10 maxdelay 0.4 offline
server 158.152.1.76 minpoll 5 maxpoll 10 maxdelay 0.4 offline
server 194.159.253.2 minpoll 5 maxpoll 10 maxdelay 0.4 offline
logdir /var/log/chrony
log statistics measurements tracking
driftfile /etc/chrony.drift
keyfile /etc/chrony.keys
commandkey 25
maxupdateskew 100.0
dumponexit
dumpdir /var/log/chrony
rtcfile /etc/chrony.rtc
</PRE>

<P>
With Freeserve as the ISP, I use the following server lines :



<PRE>
server 194.152.64.68 minpoll 5 maxpoll 10 maxdelay 0.4 offline
server 194.152.64.35 minpoll 5 maxpoll 10 maxdelay 0.4 offline
server 194.152.64.34 minpoll 5 maxpoll 10 maxdelay 0.4 offline
</PRE>

<P>
I use <CODE>pppd</CODE> for connecting to my ISP.  This runs two scripts
<TT>`/etc/ppp/ip-up'</TT> and <TT>`/etc/ppp/ip-down'</TT> when the link goes
online and offline respectively.


<P>
The relevant part of the <TT>`/etc/ppp/ip-up'</TT> file is (with a dummy
password)



<PRE>
cat &#60;&#60;EOF | /usr/local/bin/chronyc
password xxxxxxxx
online
EOF
</PRE>

<P>
and the relevant part of the <TT>`/etc/ppp/ip-down'</TT> script is



<PRE>
cat &#60;&#60;EOF | /usr/local/bin/chronyc
password xxxxxxxx
offline
dump
writertc
EOF
</PRE>

<P>
(Because they have to contain the administrator password, it would be
desirable to make the files readable only by root on a multiuser
machine).


<P>
To start <CODE>chronyd</CODE> during the boot sequence, I have the following
in <TT>`/etc/rc.d/rc.local'</TT> (this is a Slackware system)



<PRE>
if [ -f /usr/local/sbin/chronyd -a -f /etc/chrony.conf ]; then
  /usr/local/sbin/chronyd -r -s
  echo "Start chronyd"
fi
</PRE>

<P>
The Debian package puts a script which handles this and shutdown in
<TT>`/etc/init.d/chrony'</TT>.


<P>
The placement of this command may be important on some systems.  In
particular, <CODE>chronyd</CODE> may need to be started several seconds (about
10 as a minimum) before any software that depends on the system clock
not jumping or moving backwards, depending on the directives in
<CODE>chronyd's</CODE> configuration file.


<P>
For the system shutdown, <CODE>chronyd</CODE> should receive a SIGTERM several
seconds before the final SIGKILL; the SIGTERM causes the measurement
histories and RTC information to be saved out.  There should be no need
to add anything to the shutdown sequence, unless (as my system had)
there is no pause between the SIGTERM and SIGKILL being delivered to the
remaining processes.  So if you find something like



<PRE>
killall5 -15 
killall5 -9
</PRE>

<P>
in your <CODE>/etc/rc.d/rc.0</CODE> script, you will need to insert a sleep, e.g.



<PRE>
killall5 -15 
sleep 5
killall5 -9
</PRE>

<P>
Otherwise, <CODE>chronyd</CODE> will not always save information on shutdown,
which could be a problem if you don't use <CODE>dump</CODE> and
<CODE>writertc</CODE> when you go offline.




<H2><A NAME="SEC21" HREF="chrony_toc.html#TOC21">Other important configuration options</A></H2>
<P>
The most common option to include in the configuration file is the
<CODE>driftfile</CODE> option.  One of the major tasks of <CODE>chronyd</CODE> is to
work out how fast or how slow the system clock runs relative to real
time - e.g. in terms of seconds gained or lost per day.  Measurements
over a long period are usually required to refine this estimate to an
acceptable degree of accuracy.  Therefore, it would be bad if
<CODE>chronyd</CODE> had to work the value out each time it is restarted,
because the system clock would not run so accurately whilst the
determination is taking place.


<P>
To avoid this problem, <CODE>chronyd</CODE> allows the gain or loss rate to be
stored in a file, which can be read back in when the program is
restarted.  This file is called the drift file, and might typically be
stored in <TT>`/etc/chrony.drift'</TT>.  By specifying an option like the
following



<PRE>
driftfile /etc/chrony.drift
</PRE>

<P>
in the configuration file (<TT>`/etc/chrony.conf'</TT>), the drift file
facility will be activated.




<H1><A NAME="SEC22" HREF="chrony_toc.html#TOC22">Usage reference</A></H1>



<H2><A NAME="SEC23" HREF="chrony_toc.html#TOC23">Starting chronyd</A></H2>
<P>
If <CODE>chronyd</CODE> has been installed to its default location
<TT>`/usr/local/sbin/chronyd'</TT>, starting it is simply a matter of
entering the command



<PRE>
/usr/local/sbin/chronyd
</PRE>

<P>
The Debian package uses <TT>`/usr/sbin/chronyd'</TT>.


<P>
Information messages and warnings will be logged to syslog.


<P>
The command line options supported are as follows:


<DL COMPACT>

<DT><CODE>-d</CODE>
<DD>
When run in this mode, the program will not detach itself from the
terminal, and all messages will be sent to the terminal instead of to
syslog.
<DT><CODE>-f &#60;conf-file&#62;</CODE>
<DD>
This option can be used to specify an alternate location for the
configuration file (default <TT>`/etc/chrony.conf'</TT>).
<DT><CODE>-r</CODE>
<DD>
This option will reload sample histories for each of the servers being
used.  These histories are created by using the <CODE>dump</CODE> command in
<CODE>chronyc</CODE>, or by setting the <CODE>dumponexit</CODE> directive in the
configuration file.  This option is useful if you want to stop and
restart <CODE>chronyd</CODE> briefly for any reason, e.g. to install a new
version.  However, it only makes sense on systems where the kernel can
maintain clock compensation whilst not under <CODE>chronyd's</CODE> control.
The only version where this happens so far is Linux.  On systems where
this is not the case, e.g. Solaris and SunOS the option should not be
used.
<DT><CODE>-s</CODE>
<DD>
This option will set the system clock from the computer's real-time
clock.  This is analogous to supplying the `-s' flag to the
<TT>`/sbin/clock'</TT> program during the Linux boot sequence.

Support for real-time clocks is limited at present - the criteria are
described in the section on the <CODE>rtcfile</CODE> directive (see section <A HREF="chrony.html#SEC49">rtcfile</A>).

If <CODE>chronyd</CODE> cannot support the real time clock on your computer,
this option cannot be used and a warning message will be logged to the
syslog.

If used in conjunction with the `-r' flag, <CODE>chronyd</CODE> will attempt
to preserve the old samples after setting the system clock from the real
time clock.  This can be used to allow <CODE>chronyd</CODE> to perform long
term averaging of the gain or loss rate across system reboots, and is
useful for dial-up systems that are shut down when not in use.  For this
to work well, it relies on <CODE>chronyd</CODE> having been able to determine
accurate statistics for the difference between the real time clock and
system clock last time the computer was on.

<DT><CODE>-v</CODE>
<DD>
This option displays <CODE>chronyd's</CODE> version number to the terminal and
exits.
</DL>

<P>
On systems that support an <TT>`/etc/rc.local'</TT> file for starting
programs at boot time, <CODE>chronyd</CODE> can be started from there.


<P>
On systems with a System V style initialisation (e.g. Solaris), a
suitable start/stop script might be as shown below.  This might be
placed in the file <TT>`/etc/rc2.d/S83chrony'</TT>.



<PRE>
#!/bin/sh
# This file should have uid root, gid sys and chmod 744
#

killproc() {            # kill the named process(es)
        pid=`/usr/bin/ps -e |
             /usr/bin/grep -w $1 |
             /usr/bin/sed -e 's/^  *//' -e 's/ .*//'`
        [ "$pid" != "" ] &#38;&#38; kill $pid
}

case "$1" in

'start')
   if [ -f /opt/free/sbin/chronyd -a -f /etc/chrony.conf ]; then
     /opt/free/sbin/chronyd
   fi
   ;;
'stop')
   killproc chronyd
   ;;
*)
   echo "Usage: /etc/rc2.d/S83chrony { start | stop }"
   ;;
esac
</PRE>

<P>
(In both cases, you may want to bear in mind that <CODE>chronyd</CODE> can
step the time when it starts.  There may be other programs started at
boot time that could be upset by this, so you may need to consider the
ordering carefully.  However, <CODE>chronyd</CODE> will need to start after
daemons providing services that it may require, e.g. the domain name
service.)




<H2><A NAME="SEC24" HREF="chrony_toc.html#TOC24">The chronyd configuration file</A></H2>
<P>
The configuration file is normally called <TT>`/etc/chrony.conf'</TT>; in
fact, this is the compiled-in default. However, other locations can be
specified with a command line option.


<P>
Each command in the configuration file is placed on a separate line.
The following sections describe each of the commands in turn.  The
directives can occur in any order in the file.




<H3><A NAME="SEC25" HREF="chrony_toc.html#TOC25">allow</A></H3>
<P>
The <CODE>allow</CODE> command is used to designate a particular subnet from
which NTP clients are allowed to access the computer as an NTP server.


<P>
The default is that no clients are allowed access, i.e. <CODE>chronyd</CODE>
operates purely as an NTP client.  If the <CODE>allow</CODE> directive is
used, <CODE>chronyd</CODE> will be both a client of its servers, and a server
to other clients.


<P>
Examples of use of the command are as follows:



<PRE>
allow foo.bar.com
allow 1.2
allow 3.4.5
allow
</PRE>

<P>
The first command allows the named host to be an NTP client of this
computer.  The second command allows any host with an IP address of the
form 1.2.x.y (with x and y arbitrary) to be an NTP client of this
computer.  Likewise, the third command allows any host with an IP
address of the form 3.4.5.x to have client NTP access.  The fourth form
allows access by any node on the entire Internet.


<P>
A second form of the directive, <CODE>allow all</CODE>, has a greater effect,
depending on the ordering of directives in the configuration file.  To
illustrate the effect, consider the two examples



<PRE>
allow 1.2.3.4
deny 1.2.3
allow 1.2
</PRE>

<P>
and 



<PRE>
allow 1.2.3.4
deny 1.2.3
allow all 1.2
</PRE>

<P>
In the first example, the effect is the same regardles of what order the
three directives are given in.  So the 1.2.x.y subnet is allowed access,
except for the 1.2.3.x subnet, which is denied access, however the host
1.2.3.4 is allowed access.


<P>
In the second example, the <CODE>allow all 1.2</CODE> directives overrides the
effect of <EM>any</EM> previous directive relating to a subnet within the
specified subnet.  Within a configuration file this capability is
probably rather moot; however, it is of greater use for reconfiguration
at run-time via <CODE>chronyc</CODE> (see section <A HREF="chrony.html#SEC61">allow all</A>).


<P>
Note, if the <CODE>initstepslew</CODE> directive (see section <A HREF="chrony.html#SEC33">initstepslew</A>) is used in the configuration file, each of the computers
listed in that directive must allow client access by this computer for
it to work.




<H3><A NAME="SEC26" HREF="chrony_toc.html#TOC26">bindaddress</A></H3>
<P>
The bindaddress allows you to restrict the network interface to which
chronyd will listen for packets.  This provides an additional level of
access restriction above that available through the 'deny' mechanism.


<P>
Suppose you have a local ethernet with addresses in the 192.168.1.0
subnet together with a dial-up connection.  The ethernet interface's IP
address is 192.168.1.1.  Suppose (for some reason) you want to block all
access through the dialup connection (note, this will even block replies
from servers on the dialup side, so you will not be able to synchronise
to an external source).  You could add the line



<PRE>
bindaddress 192.168.1.1
</PRE>

<P>
to the configuration file.


<P>
This directive affects both NTP (UDP port 123) packets <B>and</B>
chronyc/chronyd command and monitoring packets (UDP port 323 by
default).




<H3><A NAME="SEC27" HREF="chrony_toc.html#TOC27">commandkey</A></H3>
<P>
The commandkey command is used to set the key number used for
authenticating user commands via the chronyc program at run time.
This allows certain actions of the chronyc program to be restricted to
administrators.


<P>
An example of the commandkey command is



<PRE>
commandkey 20
</PRE>

<P>
In the key file (see the keyfile command) there should be a line of
the form



<PRE>
20 foobar
</PRE>

<P>
When running the chronyc program to perform run-time configuration,
the command



<PRE>
password foobar
</PRE>

<P>
must be entered before any commands affecting the operation of the
daemon can be entered.




<H3><A NAME="SEC28" HREF="chrony_toc.html#TOC28">cmdport</A></H3>

<P>
The <CODE>cmdport</CODE> directive allows the port that is used for run-time
command and monitoring (via the program <CODE>chronyc</CODE>) to be altered
from its default (323/udp).


<P>
An example shows the syntax



<PRE>
cmdport 257
</PRE>

<P>
This would make <CODE>chronyd</CODE> use 257/udp as its command port.
(<CODE>chronyc</CODE> would need to be run with the <CODE>-p 257</CODE> switch to
inter-operate correctly).




<H3><A NAME="SEC29" HREF="chrony_toc.html#TOC29">deny</A></H3>

<P>
This is similar to the <CODE>allow</CODE> directive (see section <A HREF="chrony.html#SEC25">allow</A>),
except that it denies NTP client access to a particular subnet or host,
rather than allowing it.


<P>
The syntax is identical.


<P>
There is also a <CODE>deny all</CODE> directive with similar behaviour to the
<CODE>allow all</CODE> directive.




<H3><A NAME="SEC30" HREF="chrony_toc.html#TOC30">driftfile</A></H3>
<P>
One of the main activities of the <CODE>chronyd</CODE> program is to work out
the rate at which the system clock gains or loses time relative to real
time.


<P>
Whenever <CODE>chronyd</CODE> computes a new value of the gain/loss rate, it
is desirable to record it somewhere.  This allows <CODE>chronyd</CODE> to
begin compensating the system clock at that rate whenever it is
restarted, even before it has had a chance to obtain an equally good
estimate of the rate during the new run.  (This process may take many
minutes, at least).


<P>
The driftfile command allows a file to be specified into which
<CODE>chronyd</CODE> can store the rate information.  Two parameters are
recorded in the file.  The first is the rate at which the system clock
gains or loses time, expressed in parts per million, with gains
positive.  Therefore, a value of 100.0 indicates that when the system
clock has advanced by a second, it has gained 100 microseconds on
reality (so the true time has only advanced by 999900 microseconds).
The second is an estimate of the error bound around the first value in
which the true rate actually lies.


<P>
An example of the driftfile command is



<PRE>
driftfile /etc/chrony.drift
</PRE>



<H3><A NAME="SEC31" HREF="chrony_toc.html#TOC31">dumpdir</A></H3>
<P>
To compute the rate of gain or loss of time, <CODE>chronyd</CODE> has to store
a measurement history for each of the time sources it uses.


<P>
Certain systems (so far only Linux) have operating system support for
setting the rate of gain or loss to compensate for known errors.  (On
other systems, <CODE>chronyd</CODE> must simulate such a capability by
periodically slewing the system clock forwards or backwards by a
suitable amount to compensate for the error built up since the previous
slew).


<P>
For such systems, it is possible to save the measurement history across
restarts of <CODE>chronyd</CODE> (assuming no changes are made to the system
clock behaviour whilst it is not running).  If this capability is to be
used (via the dumponexit command in the configuration file, or the dump
command in chronyc), the dumpdir command should be used to define the
directory where the measurement histories are saved.


<P>
An example of the command is



<PRE>
dumpdir /var/log/chrony
</PRE>

<P>
A source whose IP address is 1.2.3.4 would have its measurement
history saved in the file <TT>`/var/log/chrony/1.2.3.4.dat'</TT>.




<H3><A NAME="SEC32" HREF="chrony_toc.html#TOC32">dumponexit</A></H3>
<P>
If this command is present, it indicates that <CODE>chronyd</CODE> should save
the measurement history for each of its time sources recorded whenever
the program exits.  (See the dumpdir command above).




<H3><A NAME="SEC33" HREF="chrony_toc.html#TOC33">initstepslew</A></H3>
<P>
In normal operation, <CODE>chronyd</CODE> always slews the time when it needs to
adjust the system clock.  For example, to correct a system clock which
is 1 second slow, <CODE>chronyd</CODE> slightly increases the amount by which the
system clock is advanced on each clock interrupt, until the error is
removed.  (Actually, this is done by calling the <CODE>adjtime()</CODE> or
similar system function which does it for us.)  Note that at no time
does time run backwards with this method.


<P>
On most Unix systems it is not desirable to step the system clock,
because many programs rely on time advancing monotonically forwards.


<P>
When the <CODE>chronyd</CODE> daemon is initially started, it is possible that the
system clock is considerably in error.  Attempting to correct such an
error by slewing may not be sensible, since it may take several hours
to correct the error by this means.


<P>
The purpose of the <CODE>initstepslew</CODE> directive is to allow <CODE>chronyd</CODE> to
make a rapid measurement of the system clock error at boot time, and to
correct the system clock by stepping before normal operation begins.
Since this would normally be performed only at an appropriate point in
the system boot sequence, no other software should be adversely affected
by the step.


<P>
If the correction required is less than a specified threshold, a slew is
used instead.  This makes it easier to restart <CODE>chronyd</CODE> whilst the
system is in normal operation.


<P>
The <CODE>initstepslew</CODE> directive takes a threshold and a list of NTP
servers as arguments.  A maximum of 8 will be used.  Each of the servers
is rapidly polled several times, and a majority voting mechanism used to
find the most likely range of system clock error that is present.  A
step (or slew) is applied to the system clock to correct this error.
<CODE>chronyd</CODE> then enters its normal operating mode (where only slews are
used).


<P>
An example of use of the command is



<PRE>
initstepslew 30 foo.bar.com baz.quz.com
</PRE>

<P>
where 2 NTP servers are used to make the measurement.  The <CODE>30</CODE>
indicates that if the system's error is found to be 30 seconds or less,
a slew will be used to correct it; if the error is above 30 seconds, a
step will be used.


<P>
The <CODE>initstepslew</CODE> directive can also be used in an isolated LAN
environment, where the clocks are set manually.  The most stable
computer is chosen as the master, and the other computers are slaved to
it.  If each of the slaves is configured with the local option (see
below), the master can be set up with an <CODE>initstepslew</CODE> directive
which references some or all of the slaves.  Then, if the master machine
has to be rebooted, the slaves can be relied on to 'flywheel' the time
for the master.




<H3><A NAME="SEC34" HREF="chrony_toc.html#TOC34">keyfile</A></H3>
<P>
This command is used to specify the location of the file containing
ID/key pairs for the following 2 uses:



<UL>
<LI>Authentication of NTP packets.

<LI>Authentication of administrator commands entered via chronyc.

</UL>

<P>
The format of the command is shown in the example below



<PRE>
keyfile /etc/chrony.keys
</PRE>

<P>
The argument is simply the name of the file containing the ID/key
pairs.  The format of the file is shown below



<PRE>
10 tulip
11 hyacinth
20 crocus
25 iris
 ...
</PRE>

<P>
Each line consists of an ID and a password.  The ID can be any
unsigned integer in the range 0 through 2**32-1.  The password can be
any string of characters not containing a space.


<P>
For NTP use, the MD5 authentication scheme is always used.  This must be
borne in mind if <CODE>chronyd</CODE> is to inter-operate in authenticated
mode with <CODE>xntpd</CODE> running on other computers.


<P>
The ID for the chronyc authentication key is specified with the
commandkey command (see earlier).




<H3><A NAME="SEC35" HREF="chrony_toc.html#TOC35">local</A></H3>
<P>
The local keyword is used to allow <CODE>chronyd</CODE> to appear synchronised
to real time (from the viewpoint of clients polling it), even if it has
no current synchronisation source.


<P>
This option is normally used on computers in an isolated network,
where several computers are required to synchronise to one other, this
being the "master" which is kept vaguely in line with real time by
manual input.


<P>
An example of the command is 



<PRE>
local stratum 10
</PRE>

<P>
The value 10 may be substituted with other values in the range 1
through 15.  Stratum 1 indicates a computer that has a true real-time
reference directly connected to it (e.g. GPS, atomic clock etc)
&#38;ndash; such computers are expected to be very close to real time.
Stratum 2 computers are those which have a stratum 1 server; stratum 3
computers have a stratum 2 server and so on.


<P>
A large value of 10 indicates that the clock is so many hops away from
a reference clock that its time is fairly unreliable.  Put another
way, if the computer ever has access to another computer which is
ultimately synchronised to a reference clock, it will almost certainly
be at a stratum less than 10.  Therefore, the choice of a high value
like 10 for the local command prevents the machine's own time from
ever being confused with real time, were it ever to leak out to
clients that have visibility of real servers.




<H3><A NAME="SEC36" HREF="chrony_toc.html#TOC36">log</A></H3>
<P>
The log command indicates that certain information is to be logged.


<DL COMPACT>

<DT><CODE>measurements</CODE>
<DD>
This option logs the raw NTP measurements and related information to a
file called measurements.log.

<DT><CODE>statistics</CODE>
<DD>
This option logs information about the regression processing to a file
called statistics.log.

<DT><CODE>tracking</CODE>
<DD>
This option logs changes to the estimate of the system's gain or loss
rate, and any slews made, to a file called tracking.log.

<DT><CODE>rtc</CODE>
<DD>
This option logs information about the system's real-time clock.
</DL>

<P>
The files are written to the directory specified by the logdir
command.


<P>
An example of the command is



<PRE>
log measurements statistics tracking
</PRE>



<H4><A NAME="SEC37" HREF="chrony_toc.html#TOC37">Measurements log file format</A></H4>

<P>
An example line (which actually appears as a single line in the file)
from the measurements log file is shown below.



<PRE>
22Jul98 05:40:50 158.152.1.76    N  8 1111 11 1111 10 10  1 \
   -4.966e-03  2.296e-01  1.577e-05  1.615e-01  7.446e-03
</PRE>

<P>
The columns are as follows (the quantities in square brackets are the
values from the example line above) :



<OL>
<LI>

Date [22Jul98]
<LI>

Hour:Minute:Second [05:40:50].  Note that the date/time pair is
expressed in UTC, not the local time zone.
<LI>

IP address of server/peer from which measurement comes [158.152.1.76]
<LI>

Leap status (<CODE>N</CODE> means normal, <CODE>-</CODE> means that the last minute
of today has 61 seconds, <CODE>+</CODE> means that the last minute of the day
has 59 seconds, <CODE>?</CODE> means the remote computer is not currently
synchronised.) [N]
<LI>

Stratum of remote computer. [2]
<LI>

RFC1305 tests 1 through 4 (1=pass, 0=fail) [1111]
<LI>

Tests for maximum delay and maximum delay ratio, against user defined
parameters (1=pass, 0=fail) [11]
<LI>

RFC1305 tests 5 through 8 (1=pass, 0=fail) [1111]
<LI>

Local poll [10]
<LI>

Remote poll [10]
<LI>

`Score' (an internal score within each polling level used to decide when
to increase or decrease the polling level.  This is adjusted based on
changes to the variance of the measurements obtained from the source). [1]
<LI>

The estimated local clock error (`theta' in RFC1305).  Positive indicates that the local clock is slow. [-4.966e-03].
<LI>

The peer delay (`delta' in RFC1305). [2.296e-01]
<LI>

The peer dispersion (`epsilon' in RFC1305). [1.577e-05]
<LI>

The root delay (`Delta' in RFC1305). [1.615e-01]
<LI>

The root dispersion (`E' in RFC1305). [7.446e-03]
</OL>

<P>
A banner is periodically written to the log file to indicate the
meanings of the columns.




<H4><A NAME="SEC38" HREF="chrony_toc.html#TOC38">Statistics log file format</A></H4>

<P>
An example line (which actually appears as a single line in the file)
from the measurements log file is shown below.



<PRE>
22Jul98 05:40:50 158.152.1.76     6.261e-03 -3.247e-03 \
     2.220e-03  1.874e-06  1.080e-06 7.8e-02  16   0   8
</PRE>

<P>
The columns are as follows (the quantities in square brackets are the
values from the example line above) :



<OL>
<LI>

Date [22Jul98]
<LI>

Hour:Minute:Second [05:40:50].  Note that the date/time pair is
expressed in UTC, not the local time zone.
<LI>

IP address of server/peer from which measurement comes [158.152.1.76]
<LI>

The estimated standard deviation of the measurements from the source (in
seconds). [6.261e-03]
<LI>

The estimated offset of the source (in seconds, positive means the local
clock is estimated to be fast, in this case). [-3.247e-03]
<LI>

The estimated standard deviation of the offset estimate (in
seconds). [2.220e-03]
<LI>

The estimated rate at which the local clock is gaining or losing time
relative to the source (in seconds per second, positive means the local
clock is gaining).  This is relative to the compensation currently being
applied to the local clock, <EM>not</EM> to the local clock without any
compensation. [1.874e-06]
<LI>

The estimated error in the rate value (in seconds per
second). [1.080e-06].
<LI>

The ration of |old_rate - new_rate| / old_rate_error.  Large values
indicate the statistics are not modelling the source very well. [7.8e-02]
<LI>

The number of measurements currently being used for the regression
algorithm. [16]
<LI>

The new starting index (the oldest sample has index 0; this is the
method used to prune old samples when it no longer looks like the
measurements fit a linear model). [0, i.e. no samples discarded this
time]
<LI>

The number of runs.  The number of runs of regression residuals with the
same sign is computed.  If this is too small it indicates that the
measurements are no longer represented well by a linear model and that
some older samples need to be discarded.  The number of runs for the
data that is being retained is tabulated.  Values of approximately half
the number of samples are expected. [8]
</OL>

<P>
A banner is periodically written to the log file to indicate the
meanings of the columns.




<H4><A NAME="SEC39" HREF="chrony_toc.html#TOC39">Tracking log file format</A></H4>

<P>
An example line (which actually appears as a single line in the file)
from the measurements log file is shown below.



<PRE>
22Jul98 05:40:50 158.152.1.76     3    340.529      1.606  1.046e-03
</PRE>

<P>
The columns are as follows (the quantities in square brackets are the
values from the example line above) :



<OL>
<LI>

Date [22Jul98]
<LI>

Hour:Minute:Second [05:40:50].  Note that the date/time pair is
expressed in UTC, not the local time zone.
<LI>

The IP address of the server/peer to which the local system is
synchronised. [158.152.1.76]
<LI>

The stratum of the local system. [3]
<LI>

The local system frequency (in ppm, positive means the local system runs
fast of UTC). [340.529]
<LI>

The error bounds on the frequency (in ppm) [1.606]
<LI>

The estimated local offset at the epoch (which is rapidly corrected by
slewing the local clock.  (In seconds, positive indicates the local
system is fast of UTC). [1.046e-3]
</OL>

<P>
A banner is periodically written to the log file to indicate the
meanings of the columns.




<H4><A NAME="SEC40" HREF="chrony_toc.html#TOC40">Real-time clock log file format</A></H4>

<P>
An example line (which actually appears as a single line in the file)
from the measurements log file is shown below.



<PRE>
22Jul98 05:40:50     -0.037360 1       -0.037434\
          -37.948  12   5  120
</PRE>

<P>
The columns are as follows (the quantities in square brackets are the
values from the example line above) :



<OL>
<LI>

Date [22Jul98]
<LI>

Hour:Minute:Second [05:40:50].  Note that the date/time pair is
expressed in UTC, not the local time zone.
<LI>

The measured offset between the system's real time clock and the system
(<CODE>gettimeofday()</CODE>) time.  In seconds, positive indicates that the
RTC is fast of the system time. [-0.037360].
<LI>

Flag indicating whether the regression has produced valid
coefficients. (1 for yes, 0 for no). [1]
<LI>

Offset at the current time predicted by the regression process.  A large
difference between this value and the measured offset tends to indicate
that the measurement is an outlier with a serious measurement
error. [-0.037434].
<LI>

The rate at which the RTC is losing or gaining time relative to the
system clock.  In ppm, with positive indicating that the RTC is gaining
time. [-37.948]
<LI>

The number of measurements used in the regression. [12]
<LI>

The number of runs of regression residuals of the same sign.  Low values
indicate that a straight line is no longer a good model of the measured
data and that older measurements should be discarded. [5]
<LI>

The measurement interval used prior to the measurement being made (in
seconds). [120]
</OL>

<P>
A banner is periodically written to the log file to indicate the
meanings of the columns.




<H3><A NAME="SEC41" HREF="chrony_toc.html#TOC41">logchange</A></H3>
<P>
This directive forces <CODE>chronyd</CODE> to send a message to syslog if it
makes a system clock adjustment larger than a threshold value.  An
example of use is



<PRE>
logchange 0.5
</PRE>

<P>
which would cause a syslog message to be generated a system clock error
of over 0.5 seconds starts to be compensated.


<P>
Clock errors detected either via NTP packets or via timestamps entered
via the <CODE>settime</CODE> command of <CODE>chronyc</CODE> are logged.


<P>
This directive assumes that syslog messages are appearing where somebody
can see them.  This allows that person to see if a large error has
arisen, e.g. because of a fault, or because of faulty timezone handling,
for example when summer time (daylight saving) starts or ends.




<H3><A NAME="SEC42" HREF="chrony_toc.html#TOC42">logdir</A></H3>
<P>
This directive allows the directory where log files are written to be
specified.


<P>
An example of the use of this directive is



<PRE>
logdir /var/log/chrony
</PRE>



<H3><A NAME="SEC43" HREF="chrony_toc.html#TOC43">mailonchange</A></H3>
<P>
This directive defines an email address to which mail should be sent if
chronyd applies a correction exceeding a particular threshold to the
system clock.


<P>
An example of use of this directive is



<PRE>
mailonchange root@localhost 0.5
</PRE>

<P>
This would send a mail message to root if a change of more than 0.5
seconds were applied to the system clock.




<H3><A NAME="SEC44" HREF="chrony_toc.html#TOC44">manual</A></H3>
<P>
The <CODE>manual</CODE> directive enables support at run-time for the
<CODE>settime</CODE> command in chronyc (see section <A HREF="chrony.html#SEC89">settime</A>).  If no
<CODE>manual</CODE> directive is included, any attempt to use the
<CODE>settime</CODE> command in chronyc will be met with an error message.


<P>
Note that the <CODE>settime</CODE> command can be enabled at run-time using
the <CODE>manual</CODE> command in chronyc (see section <A HREF="chrony.html#SEC78">manual</A>).  (The
idea of the two commands is that the <CODE>manual</CODE> command controls the
manual clock driver's behaviour, whereas the <CODE>settime</CODE> command
allows samples of manually entered time to be provided).




<H3><A NAME="SEC45" HREF="chrony_toc.html#TOC45">maxupdateskew</A></H3>
<P>
One of <CODE>chronyd's</CODE> tasks is to work out how fast or slow the computer's
clock runs relative to its reference sources.  In addition, it computes
an estimate of the error bounds around the estimated value.


<P>
If the range of error is too large, it probably indicates that the
measurements have not settled down yet, and that the estimated gain or
loss rate is not very reliable.


<P>
The <CODE>maxupdateskew</CODE> parameter allows the threshold for determining
whether an estimate may be so unreliable that it should not be used.


<P>
The syntax is



<PRE>
maxupdateskew &#60;skew-in-ppm&#62;
</PRE>

<P>
Typical values for &#60;skew-in-ppm&#62; might be 100 for a dial-up connection
to servers over a phone line, and 5 or 10 for a computer on a LAN.


<P>
It should be noted that this is not the only means of protection against
using unreliable estimates.  At all times, <CODE>chronyd</CODE> keeps track of
both the estimated gain or loss rate, and the error bound on the
estimate.  When a new estimate is generated following another
measurement from one of the sources, a weighted combination algorithm is
used to update the master estimate.  So if <CODE>chronyd</CODE> has an existing
highly-reliable master estimate and a new estimate is generated which
has large error bounds, the existing master estimate will dominate in
the new master estimate.




<H3><A NAME="SEC46" HREF="chrony_toc.html#TOC46">noclientlog</A></H3>
<P>
This directive, which takes no arguments, specifies that client accesses
are not to be logged.  Normally they are logged, allowing statistics to
be reported using the <CODE>clients</CODE> command in <CODE>chronyc</CODE>.




<H3><A NAME="SEC47" HREF="chrony_toc.html#TOC47">peer</A></H3>
<P>
The syntax of this directive is identical to that for the <CODE>server</CODE>
directive (see section <A HREF="chrony.html#SEC51">server</A>), except that it is used to specify
an NTP peer rather than an NTP server.




<H3><A NAME="SEC48" HREF="chrony_toc.html#TOC48">port</A></H3>
<P>
This option allows you to configure the port used for the NTP service
on your machine.


<P>
The compiled in default is udp/123, the standard NTP port.  It is
unlikely that you would ever need to change this value.  A possible
exception would be if you wanted to operate strictly in client-only
mode and never be available as a server to xntpd clients.


<P>
An example of the port command is



<PRE>
port 11123
</PRE>

<P>
This would change the NTP port served by chronyd on the computer to
udp/11123.




<H3><A NAME="SEC49" HREF="chrony_toc.html#TOC49">rtcfile</A></H3>
<P>
The <CODE>rtcfile</CODE> directive defines the name of the file in which
<CODE>chronyd</CODE> can save parameters associated with tracking the accuracy
of the system's real-time clock (RTC).


<P>
The syntax is illustrated in the following example



<PRE>
rtcfile /etc/chrony.rtc
</PRE>

<P>
<CODE>chronyd</CODE> saves information in this file when it exits and when the
<CODE>writertc</CODE> command is issued in <CODE>chronyc</CODE>.  The information
saved is the RTC's error at some epoch, that epoch (in seconds since
January 1 1970), and the rate at which the RTC gains or loses time.


<P>
So far, the support for real-time clocks is limited - their code is even
more system-specific than the rest of the software.  You can only use
the real time clock facilities (the <CODE>rtcfile</CODE> directive and the
<CODE>-s</CODE> command line option to <CODE>chronyd</CODE>) if the following three
conditions apply:



<OL>
<LI>

You are running Linux v2.0.x with x&#62;=32.

<LI>

You have compiled the kernel with extended real-time clock support
(i.e. the <TT>`/dev/rtc'</TT> device is capable of doing useful things).

<LI>

You don't have other applications that need to make use of
<TT>`/dev/rtc'</TT> at all.

</OL>



<H3><A NAME="SEC50" HREF="chrony_toc.html#TOC50">rtconutc</A></H3>

<P>
<CODE>chronyd</CODE> assumes by default that the real time clock (RTC) keeps
local time (including any daylight saving changes).  This is convenient
on PCs running Linux which are dual-booted with DOS or Windows.


<P>
NOTE : IF YOU KEEP THE REAL TIME CLOCK ON LOCAL TIME AND YOUR COMPUTER
IS OFF WHEN DAYLIGHT SAVING (SUMMER TIME) STARTS OR ENDS, THE COMPUTER'S
SYSTEM TIME WILL BE ONE HOUR IN ERROR WHEN YOU NEXT BOOT AND START
CHRONYD.


<P>
An alternative is for the RTC to keep Universal Coordinated Time (UTC).
This does not suffer from the 1 hour problem when daylight saving starts
or ends.


<P>
If the <CODE>rtconutc</CODE> directive appears, it means the RTC is required
to keep UTC.  The directive takes no arguments.  It is equivalent to
specifying the <CODE>-u</CODE> switch to the Linux <TT>`/sbin/clock'</TT> program.




<H3><A NAME="SEC51" HREF="chrony_toc.html#TOC51">server</A></H3>
<P>
The <CODE>server</CODE> directive allows NTP servers to be specified.  The
client/server relationship is strictly hierarchical : a client may
synchronise its system time to that of the server, but the server's
system time will never be influenced by that of a client.


<P>
The <CODE>server</CODE> directive is immediately followed by either the name
of the server, or its IP address in dotted-quad notation.  The server
command also supports a number of subfields (which may be defined in any
order):


<DL COMPACT>

<DT><CODE>port</CODE>
<DD>
This option allows the UDP port on which the server understands NTP
requests to be specified.  For normal servers this option should not be
required (the default is 123, the standard NTP port).
<DT><CODE>minpoll</CODE>
<DD>
Although <CODE>chronyd</CODE> will trim the rate at which it samples the
server during normal operation, the user may wish to constrain the
minimum polling interval.  This is always defined as a power of 2, so
&#60;tt/minpoll 5/ would mean that the polling interval cannot drop below 32
seconds.  The default is 6 (64 seconds).
<DT><CODE>maxpoll</CODE>
<DD>
In a similar way, the user may wish to constrain the maximum polling
interval.  Again this is specified as a power of 2, so &#60;tt/maxpoll 9/
indicates that the polling interval must stay at or below 512 seconds.
The default is 10 (1024 seconds).
<DT><CODE>maxdelay</CODE>
<DD>
<CODE>chronyd</CODE> uses the network round-trip delay to the server to
determine how accurate a particular measurement is likely to be.  Long
round-trip delays indicate that the request, or the response, or both
were delayed.  If only one of the messages was delayed the measurement
error is likely to be substantial.

For small variations in round trip delay, <CODE>chronyd</CODE> uses a
weighting scheme when processing the measurements.  However, beyond a
certain level of delay the measurements are likely to be so corrupted as
to be useless.  (This is particularly so on dial-up or other slow links,
where a long delay probably indicates a highly asymmetric delay caused
by the response waiting behind a lot of packets related to a download of
some sort).

If the user knows that round trip delays above a certain level should
cause the measurement to be ignored, this level can be defined with the
maxdelay command.  For example, &#60;tt/maxdelay 0.3/ would indicate that
measurements with a round-trip delay of 0.3 seconds or more should be
ignored.

<DT><CODE>maxdelayratio</CODE>
<DD>
This option is similar to the maxdelay option above.  <CODE>chronyd</CODE>
keeps a record of the minimum round-trip delay amongst the previous
measurements that it has buffered.  If a measurement has a round trip
delay that is greater than the maxdelayratio times the minimum delay, it
will be rejected.

<DT><CODE>presend</CODE>
<DD>
If the timing measurements being made by <CODE>chronyd</CODE> are the only
network data passing between two computers, you may find that some
measurements are badly skewed due to either the client or the server
having to do an ARP lookup on the other party prior to transmitting a
packet.  This is more of a problem with long sampling intervals, which
may be similar in duration to the lifetime of entries in the ARP caches
of the machines.

In order to avoid this problem, the <CODE>presend</CODE> option may be used.
It takes a single integer argument, which is the smallest polling
interval for which a pair of packets will be exchanged between the
client and the server prior to the actual measurement being initiated by
the client.  For example, with the following option included in a
<CODE>server</CODE> directive :


<PRE>
presend 9
</PRE>

when the polling interval is 512 seconds or more, a UDP echo datagram
will be sent to the server a short time (currently 4 seconds) before the
NTP client mode datagram.

<DT><CODE>key</CODE>
<DD>
The NTP protocol supports the inclusion of checksums in the packets, to
prevent computers having their system time upset by rogue packets being
sent to them.  The checksums are generated as a function of a password,
using the MD5 algorithm.

The association between key numbers and passwords is contained in the
keys file, defined by the keyfile command.

If the key option is present, <CODE>chronyd</CODE> will attempt to use
authenticated packets when communicating with this server.  The key
number used will be the single argument to the key option.  The server
must have the same password for this key number configured, otherwise no
relationship between the computers will be possible.

<DT><CODE>offline</CODE>
<DD>
If the server will not be reachable when <CODE>chronyd</CODE> is started, the
offline option may be specified.  <CODE>chronyd</CODE> will not try to poll
the server until it is enabled to do so (by using the online option of
<CODE>chronyc</CODE>).
</DL>



<H2><A NAME="SEC52" HREF="chrony_toc.html#TOC52">Running chronyc</A></H2>

<P>
Chronyc is the program that can be used to reconfigure options within
the <CODE>chronyd</CODE> program whilst it is running.  Chronyc can also be
used to generate status reports about the operation of <CODE>chronyd</CODE>.




<H3><A NAME="SEC53" HREF="chrony_toc.html#TOC53">Basic use</A></H3>
<P>
The program chronyc is run by entering



<PRE>
chronyc
</PRE>

<P>
at the command line.  The prompt <CODE>chronyc</CODE> is displayed whilst
chronyc is expecting input from the user, when it is being run from a
terminal.  If chronyc's input or output are redirected from/to a file,
the prompt is ow shown.


<P>
When you are finished entering commands, the commands <CODE>exit</CODE> or
<CODE>quit</CODE> will terminate the program.  (Entering <KBD>Control-D</KBD> will
also terminate the program.)




<H3><A NAME="SEC54" HREF="chrony_toc.html#TOC54">Command line options</A></H3>
<P>
Chronyc supports the following command line options.


<DL COMPACT>

<DT><CODE>-v</CODE>
<DD>
Displays the version number of chronyc on the terminal, and exists.
<DT><CODE>-h &#60;host&#62;</CODE>
<DD>
This option allows the user to specify which host running the
<CODE>chronyd</CODE> program is to be contacted.  This allows for remote
configuration, without having to telnet or rlogin to the other host
first.

The default is to contact <CODE>chronyd</CODE> running on the same host as
that where chronyc is being run.
<DT><CODE>-p &#60;port&#62;</CODE>
<DD>
This option allows the user to specify the UDP port number which the
target <CODE>chronyd</CODE> is using for its command &#38; monitoring connections.
This defaults to the compiled-in default; there would rarely be a need
to change this.
</DL>



<H3><A NAME="SEC55" HREF="chrony_toc.html#TOC55">Security with chronyc</A></H3>
<P>
Many of the commands available through chronyc have a fair amount of
power to reconfigure the run-time behaviour of <CODE>chronyd</CODE>.  Consequently,
<CODE>chronyc</CODE> is quite dangerous for the integrity of the target
system's clock performance.  Having access to <CODE>chronyd</CODE> via chronyc is
more or less equivalent to being able to modify <CODE>chronyd's</CODE> configuration
file (typically <TT>`/etc/chrony.conf'</TT>) and to restart <CODE>chronyd</CODE>.


<P>
Chronyc also provides a number of monitoring (as opposed to commanding)
commands, which will not affect the behaviour of <CODE>chronyd</CODE>.  However, you
may still want to restrict access to these commands.


<P>
In view of this, access to some of the capabilities of chronyc will
usually be tightly controlled.  There are two mechanisms supported:



<OL>
<LI>

The set of hosts from which <CODE>chronyd</CODE> will accept commands can be
restricted.  By default, commands will only be accepted from the same
host that <CODE>chronyd</CODE> is running on.
<LI>

Any command that actually reconfigures some aspect of <CODE>chronyd's</CODE>
behaviour requires the user of chronyc to know a password.  This
password is specified in <CODE>chronyd's</CODE> keys file (see section <A HREF="chrony.html#SEC34">keyfile</A>)
and specified via the commandkey option in its configuration file
(see section <A HREF="chrony.html#SEC27">commandkey</A>).
</OL>

<P>
Only the following commands can be used <EM>without</EM> providing a
password:



<UL>
<LI><CODE>exit</CODE>

<LI><CODE>help</CODE>

<LI><CODE>password</CODE>

<LI><CODE>quit</CODE>

<LI><CODE>rtcdata</CODE>

<LI><CODE>sources</CODE>

<LI><CODE>sourcestats</CODE>

<LI><CODE>tracking</CODE>

</UL>

<P>
All other commands require a password to have been specified previously,
because they affect <CODE>chronyd's</CODE> operation.




<H3><A NAME="SEC56" HREF="chrony_toc.html#TOC56">Command reference</A></H3>
<P>
This section describes each of the commands available within the chronyc
program.  Chronyc offers the user a simple command-line driven
interface.




<H4><A NAME="SEC57" HREF="chrony_toc.html#TOC57">accheck</A></H4>
<P>
This command allows you to check whether client NTP access is allowed
from a particular host.


<P>
Examples of use, showing a named host and a numeric IP address, are as
follows:



<PRE>
accheck a.b.c
accheck 1.2.3.4
</PRE>

<P>
This command can be used to examine the effect of a series of
<CODE>allow</CODE>, <CODE>allow all</CODE>, <CODE>deny</CODE> and <CODE>deny all</CODE> commands
specified either via chronyc, or in <CODE>chronyd's</CODE> configuration file.




<H4><A NAME="SEC58" HREF="chrony_toc.html#TOC58">add peer</A></H4>
<P>
The <CODE>add peer</CODE> command allows a new NTP peer to be added whilst
<CODE>chronyd</CODE> is running.


<P>
Following the words <CODE>add peer</CODE>, the syntax of the following
parameters and options is identical to that for the <CODE>peer</CODE>
directive in the configuration file (see section <A HREF="chrony.html#SEC47">peer</A>).


<P>
An example of using this command is shown below.



<PRE>
add peer foo.bar.com minpoll 6 maxpoll 10 authkey 25
</PRE>



<H4><A NAME="SEC59" HREF="chrony_toc.html#TOC59">add server</A></H4>
<P>
The <CODE>add server</CODE> command allows a new NTP server to be added whilst
<CODE>chronyd</CODE> is running.


<P>
Following the words <CODE>add server</CODE>, the syntax of the following
parameters and options is identical to that for the <CODE>server</CODE>
directive in the configuration file (see section <A HREF="chrony.html#SEC51">server</A>).


<P>
An example of using this command is shown below.



<PRE>
add server foo.bar.com minpoll 6 maxpoll 10 authkey 25
</PRE>



<H4><A NAME="SEC60" HREF="chrony_toc.html#TOC60">allow</A></H4>
<P>
The effect of the allow command is identical to the <CODE>allow</CODE> directive in
the configuration file (see section <A HREF="chrony.html#SEC25">allow</A>).


<P>
The syntax is illustrated in the following examples:



<PRE>
allow foo.bar.com
allow 1.2
allow 3.4.5
</PRE>



<H4><A NAME="SEC61" HREF="chrony_toc.html#TOC61">allow all</A></H4>
<P>
The effect of the allow command is identical to the <CODE>allow all</CODE>
directive in the configuration file (see section <A HREF="chrony.html#SEC25">allow</A>).




<H4><A NAME="SEC62" HREF="chrony_toc.html#TOC62">burst</A></H4>
<P>
The <CODE>burst</CODE> command tells <CODE>chronyd</CODE> to make a set of measurements to
each of its sources over a short duration (rather than the usual
periodic measurements that it makes).  After such a burst, <CODE>chronyd</CODE> will
revert to the previous state for each source.  This might be either
online, if the source was being periodically measured in the normal way,
or offline, if the source had been indicated as being offline.
(Switching a source between the online and offline states is described
in section <A HREF="chrony.html#SEC85">online</A>, section <A HREF="chrony.html#SEC84">offline</A>).


<P>
The syntax of the burst command is as follows



<PRE>
burst &#60;n-good-measurements&#62;/&#60;max-measurements&#62; [&#60;mask&#62;/&#60;masked-address&#62;]
</PRE>

<P>
The mask and masked-address arguments are optional, in which case
<CODE>chronyd</CODE> will initiate a burst for all of its currently defined sources.


<P>
The arguments have the following meaning and format.


<DL COMPACT>

<DT><CODE>n-good-measurements</CODE>
<DD>
This defines the number of good measurements that <CODE>chronyd</CODE> will want to
obtain from each source.  A measurement is good if it passes certain
tests, for example, the round trip time to the source must be
acceptable.  (This allows <CODE>chronyd</CODE> to reject measurements that are likely
to be bogus.)

<DT><CODE>max-measurements</CODE>
<DD>
This defines the maximum number of measurements that <CODE>chronyd</CODE> will
attempt to make, even if the required number of good measurements has
not been obtained.

<DT><CODE>mask</CODE>
<DD>
This is a dotted quad argument (e.g. <CODE>255.255.255.0</CODE>) with which
the IP address of each of <CODE>chronyd</CODE>'s sources is to be masked.

<DT><CODE>masked-address</CODE>
<DD>
This is a dotted quad argument (e.g. <CODE>1.2.3.0</CODE>).  If the masked IP
address of a source matches this value then the burst command is applied
to that source.
</DL>

<P>
If no mask or masked address arguments are provided, the default is
<CODE>0.0.0.0</CODE> and <CODE>0.0.0.0</CODE> respectively, which will match every
source.


<P>
An example of the two-argument form of the command is 



<PRE>
burst 2/10
</PRE>

<P>
This will cause <CODE>chronyd</CODE> to attempt to get two good measurements from
each source, stopping after two have been obtained, but in no event will
it try more than ten probes to the source.


<P>
An example of the four-argument form of the command is



<PRE>
burst 2/10 255.255.0.0/1.2.0.0
</PRE>

<P>
In this case, the two out of ten sampling will only be applied to
sources whose IP addresses are of the form <CODE>1.2.x.y</CODE>, where x and y
are arbitrary.




<H4><A NAME="SEC63" HREF="chrony_toc.html#TOC63">clients</A></H4>
<P>
This command shows a list of all clients that have accessed the server,
through either the NTP or command/monitoring ports.  There are no arguments.


<P>
An example of the output is


<P>
Hostname                   Client    Peer CmdAuth CmdNorm  CmdBad  LstN  LstC
=========================  ======  ======  ======  ======  ======  ====  ====
localhost                       0       0      15       1       0   29y     0
aardvark.xxx                    4       0       0       0       0    49   29y
badger.xxx                      4       0       0       0       0     6   29y


<P>
Each row shows the data for a single host.  Only hosts that have passed
the host access checks (set with the <CODE>allow</CODE>, <CODE>deny</CODE>,
<CODE>cmdallow</CODE> and <CODE>cmddeny</CODE> commands or configuration file
directives) are logged.


<P>
The columns are as follows:



<OL>
<LI>

The hostname of the client
<LI>

The number of times the client has accessed the server using an NTP
client mode packet.
<LI>

The number of times the client has accessed the server using an NTP
symmetric active mode packet.
<LI>

The number of authenticated command packets that have been processed
from the client (i.e. those following a successful <CODE>password</CODE>
command).
<LI>

The number of unauthenticated command packets that have been processed
from the client.
<LI>

The number of bad command packets received from the client (not all
forms of bad packet are logged).
<LI>

Time since the last NTP packet was received
<LI>

Time since the last command packet was received
</OL>

<P>
The last two entries will be shown as the time since 1970 if no packet
of that type has ever been received.




<H4><A NAME="SEC64" HREF="chrony_toc.html#TOC64">cmdaccheck</A></H4>
<P>
This command is similar to the <CODE>accheck</CODE> command, except that it is
used to check whether command access is permitted from a named host.


<P>
Examples of use are as follows:



<PRE>
cmdaccheck a.b.c
cmdaccheck 1.2.3.4
</PRE>



<H4><A NAME="SEC65" HREF="chrony_toc.html#TOC65">cmdallow</A></H4>
<P>
This is similar to the <CODE>allow</CODE> command, except that it is used to
allow particular hosts or subnets to use the chronyc program to interact
with <CODE>chronyd</CODE> on the current host.




<H4><A NAME="SEC66" HREF="chrony_toc.html#TOC66">cmdallow all</A></H4>
<P>
This is similar to the <CODE>allow all</CODE> command, except that it is used to
allow particular hosts or subnets to use the chronyc program to interact
with <CODE>chronyd</CODE> on the current host.




<H4><A NAME="SEC67" HREF="chrony_toc.html#TOC67">cmddeny</A></H4>
<P>
This is similar to the <CODE>deny</CODE> command, except that it is used to
allow particular hosts or subnets to use the chronyc program to interact
with <CODE>chronyd</CODE> on the current host.




<H4><A NAME="SEC68" HREF="chrony_toc.html#TOC68">cmddeny all</A></H4>
<P>
This is similar to the <CODE>deny all</CODE> command, except that it is used
to allow particular hosts or subnets to use the chronyc program to
interact with <CODE>chronyd</CODE> on the current host.




<H4><A NAME="SEC69" HREF="chrony_toc.html#TOC69">cyclelogs</A></H4>
<P>
The <CODE>cyclelogs</CODE> command causes all of <CODE>chronyd's</CODE> open log
files to be closed and re-opened.  This allows them to be renamed so
that they can be periodically purged.  An example of how to do this is shown below.



<PRE>
% mv /var/log/chrony/measurements.log /var/log/chrony/measurements1.log
% chronyc
chronyc&#62; password aardvark
200 OK
chronyc&#62; cyclelogs
200 OK
chronyc&#62; exit
% ls -l /var/log/chrony
-rw-r--r--   1 root     root            0 Jun  8 18:17 measurements.log
-rw-r--r--   1 root     root        12345 Jun  8 18:17 measurements1.log
</PRE>



<H4><A NAME="SEC70" HREF="chrony_toc.html#TOC70">delete</A></H4>
<P>
The <CODE>delete</CODE> command allows an NTP server or peer to be removed
from the current set of sources.


<P>
The syntax is illustrated in the examples below.



<PRE>
delete foo.bar.com
delete 1.2.3.4
</PRE>

<P>
There is one parameter, the name or IP address of the server or peer to
be deleted.




<H4><A NAME="SEC71" HREF="chrony_toc.html#TOC71">deny</A></H4>
<P>
The effect of the allow command is identical to the <CODE>deny</CODE>
directive in the configuration file (see section <A HREF="chrony.html#SEC29">deny</A>).


<P>
The syntax is illustrated in the following examples:



<PRE>
deny foo.bar.com
deny 1.2
deny 3.4.5
</PRE>



<H4><A NAME="SEC72" HREF="chrony_toc.html#TOC72">deny all</A></H4>
<P>
The effect of the allow command is identical to the <CODE>deny all</CODE>
directive in the configuration file (see section <A HREF="chrony.html#SEC29">deny</A>).




<H4><A NAME="SEC73" HREF="chrony_toc.html#TOC73">dump</A></H4>
<P>
The <CODE>dump</CODE> command causes <CODE>chronyd</CODE> to write its current history of
measurements for each of its sources to dump files, either for
inspection or to support the <CODE>-r</CODE> option when <CODE>chronyd</CODE> is restarted.


<P>
The <CODE>dump</CODE> command is somewhat equivalent to the <CODE>dumponexit</CODE>
directive in the chrony configuration file.  See section <A HREF="chrony.html#SEC32">dumponexit</A>.


<P>
To use the <CODE>dump</CODE>, you probably want to configure the name of the
directory into which the dump files will be written.  This can only be
done in the configuration file, see section <A HREF="chrony.html#SEC31">dumpdir</A>.




<H4><A NAME="SEC74" HREF="chrony_toc.html#TOC74">exit</A></H4>
<P>
The exit command exits from chronyc and returns the user to the shell
(same as the quit command).




<H4><A NAME="SEC75" HREF="chrony_toc.html#TOC75">help</A></H4>
<P>
The help command displays a summary of the commands and their arguments.




<H4><A NAME="SEC76" HREF="chrony_toc.html#TOC76">local</A></H4>
<P>
The <CODE>local</CODE> command allows <CODE>chronyd</CODE> to be told that it is to appear
as a reference source, even if it is not itself properly synchronised to
an external source.  (This can be used on isolated networks, to allow
one computer to be a master time server with the other computers slaving
to it.)  The <CODE>local</CODE> command is somewhat equivalent to the
<CODE>local</CODE> directive in the configuration file, see section <A HREF="chrony.html#SEC35">local</A>.


<P>
The syntax is as shown in the following examples.



<PRE>
local stratum 10
local off
</PRE>

<P>
The first example enables the local reference mode on the host, and sets
the stratum at which it should claim to be synchronised.


<P>
The second example disables the local reference mode.




<H4><A NAME="SEC77" HREF="chrony_toc.html#TOC77">makestep</A></H4>
<P>
Normally chronyd will cause the system to gradually correct any time
offset, by slowing down or speeding up the clock as required.  In
certain situations, the system clock may be so far adrift that this
slewing process would take a very long time to correct the system clock.


<P>
The <CODE>makestep</CODE> command can be used in this situation.  It cancels
any remaining correction that was being slewed, and jumps the system
clock by the equivalent amount, making it correct immediately.


<P>
BE WARNED - certain software will be seriously affected by such jumps to
the system time.  (That is the reason why chronyd uses slewing
normally.)


<P>
The <CODE>makestep</CODE> command is currently only available on the Linux
version of chrony.




<H4><A NAME="SEC78" HREF="chrony_toc.html#TOC78">manual</A></H4>
<P>
The manual command enables and disables use of the <CODE>settime</CODE>
command (see section <A HREF="chrony.html#SEC89">settime</A>), and is used to modify the behaviour
of the manual clock driver.


<P>
Examples of the command are shown below.



<PRE>
manual on
manual off
manual delete 1
manual list
manual reset
</PRE>

<P>
The <CODE>on</CODE> form of the command enables use of the <CODE>settime</CODE>
command.


<P>
The <CODE>off</CODE> form of the command disables use of the <CODE>settime</CODE>
command.


<P>
The <CODE>list</CODE> form of the command lists all the samples currently
stored in <CODE>chronyd</CODE>.  The output is illustrated below.



<PRE>
210 n_samples = 1
#    Date  Time(UTC)    Slewed   Original   Residual
====================================================
 0 27Jan99 22:09:20       0.00       0.97       0.00
</PRE>

<P>
The columns as as follows :



<OL>
<LI>

The sample index (used for the <CODE>manual delet</CODE>e command)
<LI>

The date and time of the sample
<LI>

The system clock error when the timestamp was entered, adjusted to allow
for changes made to the system clock since.
<LI>

The system clock error when the timestamp was entered, as it originally
was (without allowing for changes to the system clock since).
<LI>

The regression residual at this point, in seconds.  This allows
'outliers' to be easily spotted, so that they can be deleted using the
<CODE>manual delete</CODE> command.
</OL>

<P>
The <CODE>delete</CODE> form of the command deletes a single sample.  The
parameter is the index of the sample, as shown in the first column of
the output from <CODE>manual list</CODE>.  Following deletion of the data
point, the current error and drift rate are re-estimated from the
remaining data points and the system clock trimmed if necessary.  This
option is intended to allow 'outliers' to be discarded, i.e. samples
where the administrator realises he/she has entered a very poor
timestamp.


<P>
The <CODE>reset</CODE> form of the command deletes all samples at once.  The
system clock is left running as it was before the command was entered.




<H4><A NAME="SEC79" HREF="chrony_toc.html#TOC79">maxdelay</A></H4>
<P>
This allows the <CODE>maxdelay</CODE> option for one of the sources to be
modified, in the same way as specifying the <CODE>maxdelay</CODE> option for
the <CODE>server</CODE> directive in the configuration file (see section <A HREF="chrony.html#SEC51">server</A>).


<P>
The following examples illustrate the syntax



<PRE>
maxdelay foo.bar.com 0.3
maxdelay 1.2.3.4 0.0015
</PRE>

<P>
The first example sets the maximum network delay allowed for a
measurement to the host <CODE>foo.bar.com</CODE> to 0.3 seconds.  The second
example sets the maximum network delay for a measurement to the host
with IP address <CODE>1.2.3.4</CODE> to 1.5 milliseconds.


<P>
(Any measurement whose network delay exceeds the specified value is
discarded.)




<H4><A NAME="SEC80" HREF="chrony_toc.html#TOC80">maxdelayratio</A></H4>
<P>
This allows the <CODE>maxdelayratio</CODE> option for one of the sources to be
modified, in the same way as specifying the <CODE>maxdelayratio</CODE> option
for the <CODE>server</CODE> directive in the configuration file (see section <A HREF="chrony.html#SEC51">server</A>).


<P>
The following examples illustrate the syntax



<PRE>
maxdelayratio foo.bar.com 1.5
maxdelayratio 1.2.3.4 2.0
</PRE>

<P>
The first example sets the maximum network delay for a measurement to
the host <CODE>foo.bar.com</CODE> to be 1.5 times the minimum delay found
amongst the previous measurements that have been retained.  The second
example sets the maximum network delay for a measurement to the host
with IP address <CODE>1.2.3.4</CODE> to be double the retained minimum.


<P>
As for <CODE>maxdelay</CODE>, any measurement whose network delay is too large
will be discarded.




<H4><A NAME="SEC81" HREF="chrony_toc.html#TOC81">maxpoll</A></H4>
<P>
The <CODE>maxpoll</CODE> command is used to modify the minimum polling
interval for one of the current set of sources.  It is equivalent to the
<CODE>maxpoll</CODE> option in the <CODE>server</CODE> directive in the
configuration file (see section <A HREF="chrony.html#SEC51">server</A>).


<P>
The syntax is as follows



<PRE>
maxpoll &#60;host&#62; &#60;new-maxpoll&#62;
</PRE>

<P>
where the host can be specified as either a machine name or dotted-quad
IP address.  The new minimum poll is specified as a base-2 logarithm of
the number of seconds between polls (e.g. specify 6 for 64 second
sampling).


<P>
An example is 



<PRE>
maxpoll foo.bar.com 10
</PRE>

<P>
which sets the maximum polling interval for the host <CODE>foo.bar.com</CODE>
to 1024 seconds.


<P>
Note that the new maximum polling interval only takes effect after the
next measurement has been made.




<H4><A NAME="SEC82" HREF="chrony_toc.html#TOC82">maxupdateskew</A></H4>
<P>
This command has the same effect as the <CODE>maxupdateskew</CODE> directive
in the configuration file, see section <A HREF="chrony.html#SEC45">maxupdateskew</A>.




<H4><A NAME="SEC83" HREF="chrony_toc.html#TOC83">minpoll</A></H4>
<P>
The <CODE>minpoll</CODE> command is used to modify the minimum polling
interval for one of the current set of sources.  It is equivalent to the
<CODE>minpoll</CODE> option in the <CODE>server</CODE> directive in the
configuration file (see section <A HREF="chrony.html#SEC51">server</A>).


<P>
The syntax is as follows



<PRE>
minpoll &#60;host&#62; &#60;new-minpoll&#62;
</PRE>

<P>
where the host can be specified as either a machine name or dotted-quad
IP address.  The new minimum poll is specified as a base-2 logarithm of
the number of seconds between polls (e.g. specify 6 for 64 second
sampling).


<P>
An example is 



<PRE>
minpoll foo.bar.com 5
</PRE>

<P>
which sets the minimum polling interval for the host <CODE>foo.bar.com</CODE>
to 32 seconds.


<P>
Note that the new minimum polling interval only takes effect after the
next measurement has been made.




<H4><A NAME="SEC84" HREF="chrony_toc.html#TOC84">offline</A></H4>
<P>
The <CODE>offline</CODE> command is used to warn <CODE>chronyd</CODE> that the network
connection to a particular host or hosts is about to be lost.  It should
be used on computers with a dial-up or similar connection to their time
sources, to warn <CODE>chronyd</CODE> that the connection is about to be broken.


<P>
An example of how to use <CODE>offline</CODE> in this case is shown in
section <A HREF="chrony.html#SEC16">How to tell chronyd when the internet link is available.</A>.


<P>
Another case where <CODE>offline</CODE> could be used is where a computer
serves time to a local group of computers, and has a permanant
connection to true time servers outside the organisation.  However, the
external connection is heavily loaded at certain times of the day and
the measurements obtained are less reliable at those times.  In this
case, it is probably most useful to determine the gain/loss rate during
the quiet periods and let the whole network coast through the loaded
periods.  The <CODE>offline</CODE> and <CODE>online</CODE> commands can be used to
achieve this.  The situation is shown in the figure below.



<PRE>
          +----------+
          |Ext source|
          +----------+
              |
              |
              |/| &#60;-- Link with variable
                |     reliability
                |
      +-------------------+
      |Local master server|
      +-------------------+
                |
  +---+---+-----+-----+----+----+
  |   |   |     |     |    |    |
           Local clients
</PRE>

<P>
If the source to which <CODE>chronyd</CODE> is currently synchronised is indicated
offline in this way, <CODE>chronyd</CODE> will continue to treat it as the
synchronisation source.  If the network connection were broken without
the <CODE>offline</CODE> command being used, <CODE>chronyd</CODE> would assume that the
source had failed and would attempt to pick another synchronisation
source.


<P>
There are two forms of the <CODE>offline</CODE> command.  The first form is a
wildcard, meaning all sources.  The second form allows a IP address mask
and a masked address to be specified.  These forms are illustrated below.



<PRE>
offline
offline 255.255.255.0/1.2.3.0
</PRE>

<P>
The second form means that the <CODE>offline</CODE> command is to be applied
to any source whose IP address is in the 1.2.3 subnet.  (The host's
address is logically and-ed with the mask, and if the result matches the
masked-address the host is processed).


<P>
The wildcard form of the address is actually equivalent to



<PRE>
offline 0.0.0.0/0.0.0.0
</PRE>



<H4><A NAME="SEC85" HREF="chrony_toc.html#TOC85">online</A></H4>
<P>
The <CODE>online</CODE> command is opposite in function to the <CODE>offline</CODE>
command.  It is used to advise <CODE>chronyd</CODE> that network connectivity to a
particular source or sources has been restored.


<P>
The syntax is identical to that of the <CODE>offline</CODE> command, see
section <A HREF="chrony.html#SEC84">offline</A>.




<H4><A NAME="SEC86" HREF="chrony_toc.html#TOC86">password</A></H4>
<P>
The password command is used to allow chronyc to send privileged
commands to <CODE>chronyd</CODE>.  The password can either be entered on the command
line, or can be entered without echoing.  The syntax for entering the
password on the command line is as follows



<PRE>
password xyzzy
</PRE>

<P>
To enter the password without it being echoed, enter



<PRE>
password
</PRE>

<P>
The computer will respond with a <SAMP>`Password:'</SAMP> prompt, at which you
should enter the password and press return.  (Note that the no-echo mode
is limited to 8 characters on SunOS 4.1 due to limitations in the system
library.  Other systems do not have this restriction.)


<P>
The password is any string of characters not containing whitespace.  It
has to match <CODE>chronyd's</CODE> currently defined command key (see section <A HREF="chrony.html#SEC27">commandkey</A>).




<H4><A NAME="SEC87" HREF="chrony_toc.html#TOC87">quit</A></H4>
<P>
The quit command exits from chronyc and returns the user to the shell
(same as the exit command).




<H4><A NAME="SEC88" HREF="chrony_toc.html#TOC88">rtcdata</A></H4>
<P>
The <CODE>rtcdata</CODE> command displays the current real time clock RTC parameters.


<P>
An example output is shown below.



<PRE>
RTC ref time (GMT) : Sat May 30 07:25:56 1998
Number of samples  : 10
Number of runs     : 5
Sample span period :  549
RTC is fast by     :    -1.632736 seconds
RTC gains time at  :  -107.623 ppm
</PRE>

<P>
The fields have the following meaning


<DL COMPACT>

<DT><CODE>RTC ref time (GMT)</CODE>
<DD>
This is the RTC reading the last time its error was measured.
<DT><CODE>Number of samples</CODE>
<DD>
This is the number of previous measurements being used to determine the
RTC gain/loss rate.
<DT><CODE>Number of runs</CODE>
<DD>
This is the number of runs of residuals of the same sign following the
regression fit for (RTC error) versus (RTC time).  A value which is
small indicates that the measurements are not well approximated by a
linear model, and that the algorithm will tend to delete the older
measurements to improve the fit.
<DT><CODE>Sample span period</CODE>
<DD>
This is the period that the measurements span (from the oldest to the
newest).  Without a unit the value is in seconds; suffixes `m' for
minutes, `h' for hours, `d' for days or `y' for years may be used.
<DT><CODE>RTC is fast by</CODE>
<DD>
This is the estimate of how many seconds fast the RTC when it thought
the time was at the reference time (above).  If this value is large, you
may (or may not) want to use the <CODE>trimrtc</CODE> command to bring the RTC
into line with the system clock.  (Note, a large error will not affect
<CODE>chronyd's</CODE> operation, unless it becomes so big as to start causing
rounding errors.
<DT><CODE>RTC gains time at</CODE>
<DD>
This is the amount of time gained (positive) or lost (negative) by the
real time clock for each second that it ticks.  It is measured in parts
per million.  So if the value shown was +1, suppose the RTC was exactly
right when it crosses a particular second boundary.  Then it would be 1
microsecond fast when it crosses its next second boundary.
</DL>



<H4><A NAME="SEC89" HREF="chrony_toc.html#TOC89">settime</A></H4>
<P>
The <CODE>settime</CODE> command allows the current time to be entered
manually, if this option has been configured into <CODE>chronyd</CODE>.  (It may be
configured either with the <CODE>manual</CODE> directive in the configuration
file (see section <A HREF="chrony.html#SEC44">manual</A>), or with the <CODE>manual</CODE> command of
chronyc (see section <A HREF="chrony.html#SEC78">manual</A>).


<P>
It should be noted that the computer's sense of time will only be as
accurate as the reference you use for providing this input (e.g. your
watch), as well as how well you can time the press of the return key.
When inputting time to an isolated network, I have a battery operated
alarm clock that is synchronised to the Rugby MSF time signal in the UK.


<P>
Providing your computer's time zone is set up properly, you will be able
to enter a local time (rather than UTC).


<P>
The response to a successful <CODE>settime</CODE> command indicates the amount
that the computer's clock was wrong.  It should be apparent from this if
you have entered the time wrongly, e.g. with the wrong time zone.


<P>
The rate of drift of the system clock is estimated by a regression
process using the entered measurement and all previous measurements
entered during the present run of <CODE>chronyd</CODE>.  However, the entered
measurement is used for adjusting the current clock offset (rather than
the estimated intercept from the regression, which is ignored).
Contrast what happens with the <CODE>manual delete</CODE> command, where the
intercept is used to set the current offset (since there is no
measurement that has just been typed in in that case).


<P>
The time is parsed by the public domain <TT>`getdate'</TT> algorithm.
Consequently, you can only specify time to the nearest second.


<P>
Examples of inputs that are valid are shown below.



<PRE>
settime 16:30
settime 16:30:05
settime Nov 21, 1997 16:30:05
</PRE>

<P>
For a full description of <CODE>getdate</CODE>, get hold of the getdate
documentation (bundled, for example, with the source for GNU tar).




<H4><A NAME="SEC90" HREF="chrony_toc.html#TOC90">sources</A></H4>
<P>
This command displays information about the current time sources that
<CODE>chronyd</CODE> is accessing.  It takes no arguments.



<PRE>
210 Number of sources = 3
MS Name/IP address      Str  Poll LastRx        Last sample
===================================================================
^+ a.b.c                  3    6   47m  -9491us[-6983us] +/-  159ms
^+ d.e.f                  3    6   47m    +32ms[  +35ms] +/-  274ms
^* g.h.i                  2    6   47m  +8839us[  +11ms] +/-  214ms
</PRE>

<P>
The columns are as follows:


<DL COMPACT>

<DT><CODE>M</CODE>
<DD>
This indicates the mode of the source.  <CODE>^</CODE> means a server,
<CODE>=</CODE> means a peer and <CODE>#</CODE> indicates a locally connected
reference clock<A NAME="DOCF1" HREF="chrony_foot.html#FOOT1">(1)</A>.

<DT><CODE>S</CODE>
<DD>
This column indicates the state of the sources.  <CODE>*</CODE> indicates the
source to which <CODE>chronyd</CODE> is current synchronised.  <CODE>+</CODE> indicates
other acceptable sources.  <CODE>?</CODE> indicates sources to which
connectivity has been lost.  <CODE>x</CODE> indicates a clock which <CODE>chronyd</CODE>
thinks is is a falseticker (i.e. its time is inconsistent with a
majority of other sources).  <CODE>~</CODE> indicates a source whose time
appears to have too much variability.  The <CODE>~</CODE> condition is also
shown at start-up, until at least 3 samples have been gathered from it.

<DT><CODE>IP address</CODE>
<DD>
This shows the name or the IP address of the source.

<DT><CODE>Str</CODE>
<DD>
This shows the stratum of the source, as reported in its most recently
received sample.  Stratum 1 indicates a computer with a locally attached
reference clock.  A computer that is synchronised to a stratum 1
computer is at stratum 2.  A computer that is synchronised to a stratum
2 computer is at stratum 3, and so on.

<DT><CODE>Poll</CODE>
<DD>
This shows the rate at which the source is being polled, as a base-2
logarithm of the interval in seconds.  Thus, a value of 6 would indicate
that a measurement is being made every 64 seconds.

<CODE>chronyd</CODE> automatically varies the polling rate in response to prevailing
conditions.

<DT><CODE>LastRx</CODE>
<DD>
This column shows how long ago the last sample was received from the
source.  This is normally in seconds.  The letters <CODE>m</CODE>, <CODE>h</CODE>,
<CODE>d</CODE> or <CODE>y</CODE> indicate minutes, hours, days or years.

<DT><CODE>Last sample</CODE>
<DD>
This column shows the offset between the local clock and the source at
the last measurement.  The number in the square brackets shows the
actual measured offset.  This may be suffixed by <CODE>us</CODE> (indicating
microseconds), <CODE>ms</CODE> (indicating milliseconds), or <CODE>s</CODE>
(indicating seconds).  The number to the left of the square brackets
shows the original measurement, adjusted to allow for any slews applied
to the local clock since.  The number following the <CODE>+/-</CODE> indicator
shows the margin of error in the measurement.

Positive offsets indicate that the local clock is fast of the source.

</DL>



<H4><A NAME="SEC91" HREF="chrony_toc.html#TOC91">sourcestats</A></H4>

<P>
The <CODE>sourcestats</CODE> command displays information about the drift rate
and offset estimatation process for each of the sources currently being
examined by <CODE>chronyd</CODE>.


<P>
An example report is



<PRE>
210 Number of sources = 1
Name/IP          NP   NR  Span       Freq      Skew      S.D./us
================================================================
abc.def.ghi      11    5   46m      -0.001       0.045        25
</PRE>

<P>
The columns are as follows


<DL COMPACT>

<DT><CODE>Name/IP</CODE>
<DD>
This is the name or dotted-quad IP address of the NTP server (or peer)
to which the rest of the line relates.

<DT><CODE>NP</CODE>
<DD>
This is the number of sample points currently being retained for the
server.  The drift rate and current offset are estimated by performing a
linear regression through these points.

<DT><CODE>NR</CODE>
<DD>
This is the number of runs of residuals having the same sign following
the last regression.  If this number starts to become too small relative
to the number of samples, it indicates that a straight line is no longer
a good fit to the data.  If the number of runs is too low,
<CODE>chronyd</CODE> discards older samples and re-runs the regression until
the number of runs becomes acceptable.

<DT><CODE>Span</CODE>
<DD>
This is the interval between the oldest and newest samples.  If no unit
is shown the value is in seconds.  In the example, the interval is 46
minutes.

<DT><CODE>Freq</CODE>
<DD>
This is the estimated residual frequency for the server, in parts per
million.  In this case, the computer's clock is estimated to be running
1 part in 10**9 slow relative to the server.

<DT><CODE>Skew</CODE>
<DD>
This is the estimated error bounds on <CODE>Freq</CODE> (again in parts per
million).

<DT><CODE>Var/us</CODE>
<DD>
This is the estimated sample variance in microseconds.

</DL>



<H4><A NAME="SEC92" HREF="chrony_toc.html#TOC92">tracking</A></H4>
<P>
The <CODE>tracking</CODE> command displays parameters about the system's clock
performance.  An example of the output is shown below.



<PRE>
Reference ID    : 1.2.3.4 (a.b.c)
Stratum         : 3
Ref time (UTC)  : Sun May 17 06:13:11 1998
System time     : 0.000000 seconds fast of NTP time
Frequency       : 331.898 ppm fast
Residual freq   : 0.004 ppm
Skew            : 0.154 ppm
Root delay      : 0.373169 seconds
Root dispersion : 0.024780 seconds
</PRE>

<P>
The fields are explained as follows.


<DL COMPACT>

<DT><CODE>Reference ID</CODE>
<DD>
This is the IP address, and name if available, of the server to which
the computer is currently synchronised.  If this is <CODE>127.127.1.1</CODE>
it means the computer is not synchronised to any external source and
that you have the `local' mode operating (via the <CODE>local</CODE> command
in <CODE>chronyc</CODE> (see section <A HREF="chrony.html#SEC76">local</A>), or the <CODE>local</CODE> directive
in the <TT>`/etc/chrony.conf'</TT> file (see section <A HREF="chrony.html#SEC35">local</A>)).

<DT><CODE>Stratum</CODE>
<DD>
The stratum indicates how many hops away from a computer with an
attached reference clock we are.  Such a computer is a stratum-1
computer, so the computer in the example is two hops away
(i.e. <CODE>a.b.c</CODE> is a stratum-2 and is synchronised from a stratum-1).

<DT><CODE>Ref time</CODE>
<DD>
This is the time (GMT) at which the last measurement from the reference
source was processed.

<DT><CODE>System time</CODE>
<DD>
In normal operation, <CODE>chronyd</CODE> <EM>never</EM> steps the system clock,
because any jump in the timescale can have adverse consequences for
certain application programs.  Instead, any error in the system clock is
corrected by slightly speeding up or slowing down the system clock until
the error has been removed, and then returning to the system clock's
normal speed.  A consequence of this is that there will be a period when
the system clock (as read by other programs using the
<CODE>gettimeofday()</CODE> system call, or by the <CODE>date</CODE> command in the
shell) will be different from <CODE>chronyd's</CODE> estimate of the current
true time (which it reports to NTP clients when it is operating in
server mode).  The value reported on this line is the difference due to
this effect.

On systems such as Solaris and SunOS, <CODE>chronyd</CODE> has no means to
adjust the fundamental rate of the system clock, so keeps the system
time correct by periodically making offsets to it as though an error had
been measured.  The build up of these offsets will be observed in this
report.  On systems such as Linux where <CODE>chronyd</CODE> can adjust the
fundamental rate of the system clock, this value will show zero unless a
very recent measurement has shown the system to be error.

<DT><CODE>Frequency</CODE>
<DD>
The `frequency' is the rate by which the system's clock would be would
be wrong if <CODE>chronyd</CODE> was not correcting it.  It is expressed in
ppm (parts per million).  For example, a value of 1ppm would mean that
when the system's clock thinks it has advanced 1 second, it has actually
advanced by 1.000001 seconds relative to true time.

As you can see in the example, the clock in the computer I developed
<CODE>chrony</CODE> on is not a very good one - it gains about 30 seconds per
day!  This was the reason I started to write <CODE>chrony</CODE> in the first
place.
 
<DT><CODE>Residual freq</CODE>
<DD>
This shows the `residual frequency' for the currently selected reference
source.  This reflects any difference between what the measurements from
the reference source indicate the frequency should be and the frequency
currently being used.

The reason this is not always zero is that a smoothing procedure is
applied to the frequency.  Each time a measurement from the reference
source is obtained and a new residual frequency computed, the estimated
accuracy of this residual is compared with the estimated accuracy (see
`skew' next) of the existing frequency value.  A weighted average is
computed for the new frequency, with weights depending on these
accuracies.  If the measurements from the reference source follow a
consistent trend, the residual will be driven to zero over time.

<DT><CODE>Skew</CODE>
<DD>
This is the estimated error bound on the the frequency.

<DT><CODE>Root delay</CODE>
<DD>
This is the total of the network path delays to the stratum-1 computer
from which the computer is ultimately synchronised.

In certain extreme situations, this value can be negative.  (This can
arise in a symmetric peer arrangement where the computers' frequencies
are not tracking each other and the network delay is very short relative
to the turn-around time at each computer.)

<DT><CODE>Root dispersion</CODE>
<DD>
This is the total dispersion accumulated through all the computers back
to the stratum-1 computer from which the computer is ultimately
synchronised.  Dispersion is due to system clock resolution, statistical
measurement variations etc.

An absolute bound on the computer's clock accuracy (assuming the
stratum-1 computer is correct) is given by 


<PRE>
clock_error &#60;= root_dispersion + (0.5 * |root_delay|)
</PRE>

</DL>



<H4><A NAME="SEC93" HREF="chrony_toc.html#TOC93">trimrtc</A></H4>
<P>
The <CODE>trimrtc</CODE> command is used to correct the system's real time
clock (RTC) to the main system clock.  It has no effect if the error
between the two clocks is currently estimated at less than a second (the
resolution of the RTC is only 1 second).


<P>
The command takes no arguments.  It performs the following steps (if the
RTC is more than 1 second away from the system clock):



<OL>
<LI>

Remember the currently estimated gain/loss rate of the RTC and flush the
previous measurements.
<LI>

Step the real time clock to bring it within a second of the system clock.
<LI>

Make several measurements to accurately determine the new offset between
the RTC and the system clock (i.e. the remaining fraction of a second
error)
<LI>

Save the RTC parameters to the RTC file (specified with the
<CODE>rtcfile</CODE> directive in the configuration file (see section <A HREF="chrony.html#SEC49">rtcfile</A>).
</OL>

<P>
The last step is done as a precaution against the computer suffering a
power failure before either the daemon exits or the <CODE>writertc</CODE>
command is issued.


<P>
<CODE>chronyd</CODE> will still work perfectly well both whilst operating and
across machine reboots even if the <CODE>trimrtc</CODE> command is never used
(and the RTC is allowed to drift away from true time).  The
<CODE>trimrtc</CODE> command is provided as a method by which it can be
corrected, in a manner compatible with <CODE>chronyd</CODE> using it to
maintain accurate time across machine reboots.




<H4><A NAME="SEC94" HREF="chrony_toc.html#TOC94">writertc</A></H4>
<P>
The <CODE>writertc</CODE> command writes the currently estimated error and
gain/loss rate parameters for the RTC to the RTC file (specified with
the <CODE>rtcfile</CODE> directive (see section <A HREF="chrony.html#SEC49">rtcfile</A>)).  This
information is also written automatically when <CODE>chronyd</CODE> is killed
(with SIGHUP, SIGINT, SIGQUIT or SIGTERM).




<H1><A NAME="SEC95" HREF="chrony_toc.html#TOC95">Porting guide</A></H1>
<P>
This appendix discusses issues that have arisen in writing the
system-specific parts of the existing ports.  This will provide useful
information for those attempting to write ports to other systems.




<H2><A NAME="SEC96" HREF="chrony_toc.html#TOC96">System driver files</A></H2>
<P>
The system specific parts of the software are contained in files with
names like <CODE>sys_linux.c</CODE>.


<P>
The following functions are required in a system driver file:



<OL>
<LI>

A function to read the current frequency
<LI>

A function to set the current frequency
<LI>

A function to slew the system time by a specified delta
<LI>

A function to step the system time by a specified delta
<LI>

A function to work out the error at a particular time between the
system's clock and <CODE>chronyd's</CODE> estimate of real time.  (This is required
because some systems have to track real time by making the system time
follow it in a 'sawtooth' fashion).
</OL>

<P>
The <EM>frequency</EM> is the rate at which the system gains or loses time,
measured relative to the system when running uncompensated.




<H2><A NAME="SEC97" HREF="chrony_toc.html#TOC97">Quirks of particular systems</A></H2>

<P>
These sections describe quirks in each system type that needed to be
investigated to port the software to each system type.




<H3><A NAME="SEC98" HREF="chrony_toc.html#TOC98">Linux</A></H3>
<P>
The following quirks have been found in developing the Linux port.



<OL>
<LI>

In order to avoid floating point arithmetic, the kernel uses shifting
and adding to approximate a scaling of 100/128.  This approximation
implies that the frequency set via the <CODE>adjtimex()</CODE> system call is
not the frequency that is actually obtained.  The method of
approximation varies between kernel versions and must be determined by
examining the kernel source.  An inverse factor must be included in the
driver to compensate.
<LI>

In some kernel versions, an <CODE>adjtimex()</CODE> system call with the flags
bits all zeroed will return the amount of offset still to be corrected.
In others (e.g. the 2.0 series beyond 2.0.32), the offset must be
changed in order to get the old offset returned (similar to
<CODE>adjtime()</CODE> on other systems).

</OL>



<H3><A NAME="SEC99" HREF="chrony_toc.html#TOC99">Solaris 2.5</A></H3>

<P>
The following quirks have been found in developing the Solaris port.



<OL>
<LI>

The <CODE>adjtime()</CODE> system call with a zero argument does not cancel an
adjustment that is in progress - it just reports the remaining
adjustment.
<LI>

The <CODE>settimeofday()</CODE> system call only observes the seconds part of
the argument - any fractional seconds part is lost.
second.
<LI>

The kernel variable <CODE>dosynctodr</CODE> has to be set to zero, otherwise
the system clock is periodically reset to the real-time clock.
</OL>



<H3><A NAME="SEC100" HREF="chrony_toc.html#TOC100">SunOS 4.1.4</A></H3>
<P>
The following quirks have been found in developing the SunOS port.



<OL>
<LI>

The <CODE>adjtime()</CODE> system call truncates its argument to a multiple of
the system's <CODE>tickadj</CODE> variable.  (<CODE>chronyd</CODE> sets that to 100,
giving a 1 part in 100 slewing capability for correcting offsets.)
<LI>

The kernel variable <CODE>dosynctodr</CODE> has to be set to zero, otherwise
the system clock is periodically reset to the real-time clock.
</OL>

<P><HR><P>
This document was generated on 19 November 2000 using
<A HREF="http://wwwinfo.cern.ch/dis/texi2html/">texi2html</A>&nbsp;1.56k.
</BODY>
</HTML>
